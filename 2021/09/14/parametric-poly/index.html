<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#7350B9"><meta name="author" content="ayanamists"><meta name="copyright" content="ayanamists"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>c++模板与参数多态的根本区别 | aya ⊢ blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#7350B9"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"ayanamists.xyz","root":"/","title":"云游君的小站","version":"1.6.2","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="c++模板与参数多态 模板(template)是一种c++语言特性，类似于： template &lt;class T&gt; T id(T x) &amp;#123;     return x; &amp;#125; 这里的T可以是任意类型。很多人都注意到了这与参数多态(parametric polymorphism)的相似性，更有甚者直接把模板机制看作是一种参数多态。比如这份ppt和这个网页。 然而这篇博客中，我">
<meta property="og:type" content="article">
<meta property="og:title" content="c++模板与参数多态的根本区别">
<meta property="og:url" content="https://ayanamists.xyz/2021/09/14/parametric-poly/index.html">
<meta property="og:site_name" content="aya ⊢ blog">
<meta property="og:description" content="c++模板与参数多态 模板(template)是一种c++语言特性，类似于： template &lt;class T&gt; T id(T x) &amp;#123;     return x; &amp;#125; 这里的T可以是任意类型。很多人都注意到了这与参数多态(parametric polymorphism)的相似性，更有甚者直接把模板机制看作是一种参数多态。比如这份ppt和这个网页。 然而这篇博客中，我">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://homepages.inf.ed.ac.uk/wadler/gj/gj-front-full.jpg">
<meta property="article:published_time" content="2021-09-14T15:53:47.000Z">
<meta property="article:modified_time" content="2021-09-14T12:18:52.837Z">
<meta property="article:author" content="ayanamists">
<meta property="article:tag" content="c++">
<meta property="article:tag" content="编程语言基础">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://homepages.inf.ed.ac.uk/wadler/gj/gj-front-full.jpg"><script src="/js/ui/mode.js"></script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="ayanamists"><img width="96" loading="lazy" src="/avatar.jpg" alt="ayanamists"></a><div class="site-author-name"><a href="/about/">ayanamists</a></div><span class="site-name">aya ⊢ blog</span><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">50</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">8</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">50</span></a></div><a class="site-state-item hty-icon-button" href="/about/" title="关于"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-information-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/ayanamists" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:ayanamists@gmail.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/191397140/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/woodwardchenxi" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/288120032" title="哔哩哔哩动画" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="友情链接" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-heart-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#c%E6%A8%A1%E6%9D%BF%E4%B8%8E%E5%8F%82%E6%95%B0%E5%A4%9A%E6%80%81"><span class="toc-number">1.</span> <span class="toc-text"> c++模板与参数多态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%B0%E5%BA%95%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%82%E6%95%B0%E5%A4%9A%E6%80%81"><span class="toc-number">2.</span> <span class="toc-text"> 到底什么是参数多态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c%E6%A8%A1%E6%9D%BF%E6%BB%A1%E8%B6%B3%E5%91%BD%E9%A2%981%E5%90%97"><span class="toc-number">3.</span> <span class="toc-text"> C++模板满足命题1.吗？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E7%B1%BB%E5%BD%B1%E5%93%8D%E9%97%AE%E9%A2%98%E5%90%97"><span class="toc-number">4.</span> <span class="toc-text"> 类型类影响问题吗？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%9F%E5%81%87%E6%B3%9B%E5%9E%8B%E6%80%A7%E8%83%BD%E6%9B%B4%E5%A5%BD"><span class="toc-number">5.</span> <span class="toc-text"> 真假泛型？性能更好？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#concept-%E8%83%BD%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%E5%90%97"><span class="toc-number">6.</span> <span class="toc-text"> concept: 能解决问题吗？</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://ayanamists.xyz/2021/09/14/parametric-poly/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="ayanamists"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="aya ⊢ blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">c++模板与参数多态的根本区别</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2021-09-14 15:53:47" itemprop="dateCreated datePublished" datetime="2021-09-14T15:53:47+00:00">2021-09-14</time></div><span class="post-busuanzi"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Views"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span id="busuanzi_value_page_pv"></span></span></span><div class="post-classify"><span class="post-tag"><a class="tag-item" href="/tags/c/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">c++</span></a><a class="tag-item" href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">编程语言基础</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#7350B9;"><h2 id="c模板与参数多态"><a class="markdownIt-Anchor" href="#c模板与参数多态"></a> c++模板与参数多态</h2>
<p>模板(template)是一种c++语言特性，类似于：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
T <span class="token function">id</span><span class="token punctuation">(</span>T x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的<code>T</code>可以是任意类型。很多人都注意到了这与参数多态(parametric polymorphism)的相似性，更有甚者直接把模板机制看作是一种参数多态。比如这份<a target="_blank" rel="noopener" href="https://www.cs.bham.ac.uk/~hxt/2015/c-plus-plus/templates-slides.pdf">ppt</a>和这个<a target="_blank" rel="noopener" href="https://catonmat.net/cpp-polymorphism">网页</a>。</p>
<p>然而这篇博客中，我将会说明，<strong>无论c++模板到底是不是一个好的语言特性，它都和参数多态有根本性的区别</strong>。</p>
<h2 id="到底什么是参数多态"><a class="markdownIt-Anchor" href="#到底什么是参数多态"></a> 到底什么是参数多态</h2>
<p>参数多态的历史要追溯一份讲义(<a target="_blank" rel="noopener" href="https://link.springer.com/article/10.1023%2FA%3A1010000313106">Fundamental Concepts in Programming Languages</a>)，讲义虽然主要描述的是CPL语言，但是实际上这一段应该描述的是LISP的MAP函数：</p>
<blockquote>
<p>Parametric polymorphism is more regular and may be illustrated by an example. Suppose f is a function whose argument is of type α and whose results is of β (so that the type of f might be written α ⇒ β), and that L is a list whose elements are all of type α (so that the type of L is α list). We can imagine a function, say Map, which applies f in turn to each member of L and makes a list of the results. Thus Map[f,L] will produce a β list. We would like Map to work on all types of list provided f was a suitable function, so that Map would have to be polymorphic. However its polymorphism is of a particularly simple parametric type which could be written</p>
</blockquote>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mi>α</mi><mo>→</mo><mi>β</mi><mo separator="true">,</mo><mi>α</mi><mtext> </mtext><mi>l</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo stretchy="false">)</mo><mo>→</mo><mi>β</mi><mtext> </mtext><mi>l</mi><mi>i</mi><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">(α → β , α\ list) → β \ list
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span></span></span></span></span></p>
<p>虽然有了构想，但是直到1970年代的Jean-Yves Girard的二阶直觉主义命题逻辑（second order propositional logic，注意不要和二阶逻辑⁽second order logic⁾搞混）和John C. Reynolds的系统F（System F），这种特性才得到了理论阐释。最终在1975年的ML语言中得到实现。</p>
<p>在ML类语言中，一个函数的类型中可以含有类型变量，例如如下的<code>id</code>函数：</p>
<pre class="line-numbers language-ocaml" data-language="ocaml"><code class="language-ocaml"><span class="token keyword">let</span> id <span class="token punctuation">(</span>x<span class="token punctuation">:</span><span class="token type-variable function">'a</span><span class="token punctuation">)</span> <span class="token operator">=</span> x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>id</code>函数的类型是<code>'a -&gt; 'a</code>，其中<code>'a</code>就是一个类型变量，它可以与<strong>任意</strong>类型相匹配，所以得到</p>
<pre class="line-numbers language-ocaml" data-language="ocaml"><code class="language-ocaml">id <span class="token number">1</span>
id <span class="token string">"ssdfs"</span>
id <span class="token number">1.23</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>都是合法的表达式。ML类语言的类型系统可以看作是对System F进行限制和扩展后的系统。System F可以看作对λ表达式的扩展，在system F中，λ表达式的每个绑定变量都必须给定一个类型，而这个类型则是通过<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">Λ</mi></mrow><annotation encoding="application/x-tex">Λ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Λ</span></span></span></span>（大写的λ）引入的。</p>
<p>具体来说，最基本的λ表达式<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi><mi>x</mi><mi mathvariant="normal">.</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">λx.x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">λ</span><span class="mord mathdefault">x</span><span class="mord">.</span><span class="mord mathdefault">x</span></span></span></span>在System F中应该写作：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">Λ</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>λ</mi><mo stretchy="false">(</mo><mi>x</mi><mo>:</mo><mi>t</mi><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">Λt.λ (x:t).x
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Λ</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mord mathdefault">λ</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathdefault">x</span></span></span></span></span></p>
<p>而这个表达式的类型是</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">∀</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>t</mi><mo>→</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">∀t.t → t
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">∀</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span></span></span></span></span></p>
<p>这个大<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">Λ</mi></mrow><annotation encoding="application/x-tex">Λ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Λ</span></span></span></span>引入的类型变量在使用时需要得到显式apply（就像对小<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">λ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">λ</span></span></span></span>的apply一样）。在System F中，类似于λ表达式，没有除了<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">λ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">λ</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">Λ</mi></mrow><annotation encoding="application/x-tex">Λ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Λ</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">∀</mi></mrow><annotation encoding="application/x-tex">∀</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">∀</span></span></span></span>以外的东西，如果给它暂时加入整数类型（例如<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo>:</mo><mtext>Int</mtext></mrow><annotation encoding="application/x-tex">1: \text{Int}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord">Int</span></span></span></span></span>），那么就可以给出这样的求值实例:</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi mathvariant="normal">Λ</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>λ</mi><mo stretchy="false">(</mo><mi>x</mi><mo>:</mo><mi>t</mi><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mi>x</mi><mo stretchy="false">)</mo><mtext>Int</mtext><mo stretchy="false">)</mo><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≡</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo stretchy="false">(</mo><mi>λ</mi><mo stretchy="false">(</mo><mi>x</mi><mo>:</mo><mtext>Int</mtext><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mi>x</mi><mo stretchy="false">)</mo><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≡</mo><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
((Λ t. λ (x:t). x) \text{Int})1 &amp; ≡ \\
(λ (x:\text{Int}). x) 1 &amp; ≡ 1
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.0000000000000004em;vertical-align:-1.2500000000000002em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mopen">(</span><span class="mord">Λ</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mord mathdefault">λ</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mord text"><span class="mord">Int</span></span><span class="mclose">)</span><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault">λ</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class="mord">Int</span></span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>由于Hindey-Milner类型推理算法的存在，ML类语言中无须手动给出这样的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>Int</mtext></mrow><annotation encoding="application/x-tex">\text{Int}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord">Int</span></span></span></span></span>，函数的类型也会自动推导为带有全称量词的形式。虽然为了进行推理，某些在System F中合法的式子不能在ML中被构造，但搞清楚System F的类型规则对接下来的讨论是大有裨益的。</p>
<p>System F的类型规则分为四个规则：</p>
<ol>
<li>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mfrac><mrow><mi mathvariant="normal">Γ</mi><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>x</mi><mo>:</mo><mi>t</mi><mi mathvariant="normal">₁</mi><mo stretchy="false">)</mo><mo>⊢</mo><mi>y</mi><mo>:</mo><mi>t</mi><mi mathvariant="normal">₂</mi></mrow><mrow><mi mathvariant="normal">Γ</mi><mo>⊢</mo><mo stretchy="false">(</mo><mi>λ</mi><mo stretchy="false">(</mo><mi>x</mi><mo>:</mo><mi>t</mi><mi mathvariant="normal">₁</mi><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mi>y</mi><mo stretchy="false">)</mo><mo>:</mo><mi>t</mi><mi mathvariant="normal">₁</mi><mo>→</mo><mi>t</mi><mi mathvariant="normal">₂</mi></mrow></mfrac><mrow></mrow></msub></mrow><annotation encoding="application/x-tex">{\frac{Γ , (x:t₁) ⊢ y:t₂}{Γ ⊢ (λ(x:t₁).y):t₁ → t₂}}_{}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4127em;vertical-align:-0.9857em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Γ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⊢</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord mathdefault">λ</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">t</span><span class="mord">₁</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">t</span><span class="mord">₁</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">t</span><span class="mord">₂</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Γ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">t</span><span class="mord">₁</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⊢</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">t</span><span class="mord">₂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.9857em;"><span style="top:-1.0143em;margin-right:0.05em;"><span class="pstrut" style="height:2em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9857em;"><span></span></span></span></span></span></span></span></span></span></span></p>
</li>
<li>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mi mathvariant="normal">Γ</mi><mo separator="true">,</mo><mi>A</mi><mo>:</mo><mrow><mi mathvariant="bold">t</mi><mi mathvariant="bold">y</mi><mi mathvariant="bold">p</mi><mi mathvariant="bold">e</mi></mrow><mo>⊢</mo><mi>x</mi><mo>:</mo><mi>t</mi><mi mathvariant="normal">₁</mi></mrow><mrow><mi mathvariant="normal">Γ</mi><mo>⊢</mo><mo stretchy="false">(</mo><mi mathvariant="normal">Λ</mi><mi>A</mi><mi mathvariant="normal">.</mi><mi>x</mi><mo stretchy="false">)</mo><mo>:</mo><mi mathvariant="normal">∀</mi><mi>A</mi><mi mathvariant="normal">.</mi><mi>t</mi><mi mathvariant="normal">₁</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{Γ , A:\bold{type} ⊢ x:t₁ }{ Γ ⊢ (Λ A.x): ∀ A. t₁}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3074399999999997em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Γ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⊢</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord">Λ</span><span class="mord mathdefault">A</span><span class="mord">.</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">∀</span><span class="mord mathdefault">A</span><span class="mord">.</span><span class="mord mathdefault">t</span><span class="mord">₁</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Γ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathbf">t</span><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="mord mathbf">p</span><span class="mord mathbf">e</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⊢</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">t</span><span class="mord">₁</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
</li>
<li>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mi mathvariant="normal">Γ</mi><mo>⊢</mo><mi>x</mi><mo>:</mo><mo stretchy="false">(</mo><mi>t</mi><mi mathvariant="normal">₁</mi><mo>→</mo><mi>t</mi><mi mathvariant="normal">₂</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>y</mi><mo>:</mo><mi>t</mi><mi mathvariant="normal">₁</mi></mrow><mrow><mi mathvariant="normal">Γ</mi><mo>⊢</mo><mo stretchy="false">(</mo><mi>x</mi><mtext> </mtext><mi>y</mi><mo stretchy="false">)</mo><mo>:</mo><mi>t</mi><mi mathvariant="normal">₂</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{Γ ⊢ x:(t₁ → t₂), y:t₁}{Γ ⊢ (x\ y): t₂}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Γ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⊢</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">t</span><span class="mord">₂</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Γ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⊢</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mord">₁</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">t</span><span class="mord">₂</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">t</span><span class="mord">₁</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
</li>
<li>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mi mathvariant="normal">Γ</mi><mo>⊢</mo><mi>x</mi><mo>:</mo><mo stretchy="false">(</mo><mi mathvariant="normal">∀</mi><mi>A</mi><mi mathvariant="normal">.</mi><mi>t</mi><mi mathvariant="normal">₁</mi><mo stretchy="false">)</mo><mtext>    </mtext><mo stretchy="false">(</mo><mi>B</mi><mo>:</mo><mrow><mi mathvariant="bold">t</mi><mi mathvariant="bold">y</mi><mi mathvariant="bold">p</mi><mi mathvariant="bold">e</mi></mrow><mo stretchy="false">)</mo></mrow><mrow><mi mathvariant="normal">Γ</mi><mo>⊢</mo><mo stretchy="false">(</mo><mi>x</mi><mtext> </mtext><mi>B</mi><mo stretchy="false">)</mo><mo>:</mo><mo stretchy="false">[</mo><mi>B</mi><mi mathvariant="normal">/</mi><mi>A</mi><mo stretchy="false">]</mo><mi>t</mi><mi mathvariant="normal">₁</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{Γ ⊢ x:(∀A.t₁)\  \ \ \ (B:\bold{type})}{ Γ ⊢ (x\ B):[B/A]t₁}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Γ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⊢</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord">/</span><span class="mord mathdefault">A</span><span class="mclose">]</span><span class="mord mathdefault">t</span><span class="mord">₁</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Γ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⊢</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord">∀</span><span class="mord mathdefault">A</span><span class="mord">.</span><span class="mord mathdefault">t</span><span class="mord">₁</span><span class="mclose">)</span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathbf">t</span><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="mord mathbf">p</span><span class="mord mathbf">e</span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
</li>
</ol>
<p>从规则2.中可以看到，这里的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span>是<strong>任意</strong>的类型，引入这个<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">Λ</mi></mrow><annotation encoding="application/x-tex">Λ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Λ</span></span></span></span>的条件是无论<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span>到底是什么类型，它都可以推出<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span>是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mi mathvariant="normal">₁</mi></mrow><annotation encoding="application/x-tex">t₁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span><span class="mord">₁</span></span></span></span>类型。这样一来，在规则4.中，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span>也是一个<strong>任意</strong>的类型。可以不加证明地得到：</p>
<p><strong>命题1.</strong> 如果<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mi mathvariant="normal">Λ</mi><mi>A</mi><mi mathvariant="normal">.</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(ΛA.x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">Λ</span><span class="mord mathdefault">A</span><span class="mord">.</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span>是一个系统F中的封闭项，那么对于任意的类型<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi mathvariant="normal">Λ</mi><mi>A</mi><mi mathvariant="normal">.</mi><mi>x</mi><mo stretchy="false">)</mo><mtext> </mtext><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">((ΛA.x)\ t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mopen">(</span><span class="mord">Λ</span><span class="mord mathdefault">A</span><span class="mord">.</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace"> </span><span class="mord mathdefault">t</span><span class="mclose">)</span></span></span></span>是一个系统F中的封闭项。</p>
<p>命题1.是任何声称自己实现了参数多态的系统所必须满足的命题。在ML类语言中，它表现为，一个类型为<code>'a -&gt; b</code>（这里的<code>b</code>没有加引号，表示任何可能的类型，比如<code>'a</code>，这样一来就是<code>'a -&gt; 'a</code>）的函数<code>f</code>，对于任何类型为<code>t</code>的合法ML表达式<code>x</code>，<code>f x</code>的类型都是<code>[t/'a]b</code>.</p>
<p>例如之前的<code>id</code>函数，<code>id 10</code>的类型就是<code>[int/'a]'a</code>，即<code>int</code>.</p>
<p>事实上，参数多态满足更强的条件–parametricity，鉴于比较复杂，这里暂不解释其含义。</p>
<h2 id="c模板满足命题1吗"><a class="markdownIt-Anchor" href="#c模板满足命题1吗"></a> C++模板满足命题1.吗？</h2>
<p>答案是很显然的：<strong>不满足</strong>。这也就是为什么C++模板不是参数多态的一个原因。</p>
<p>例如说，<code>id</code>函数可以写成：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
T <span class="token function">id</span><span class="token punctuation">(</span>T x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果之前没有写过，你可能会惊讶地发现，这竟然是<strong>不会报错</strong>的！事实上，无论怎么写，它都不会报错：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">int</span> <span class="token function">id</span><span class="token punctuation">(</span>T x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>它真正报错的位置，是在对<code>id</code>函数进行使用的时候：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">auto</span> x <span class="token operator">=</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"sdfsdf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token punctuation">.</span>\test<span class="token punctuation">.</span>cpp<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span> error<span class="token operator">:</span> cannot initialize <span class="token keyword">return</span> object of type <span class="token string">'const char *'</span>
      with an rvalue of type <span class="token string">'int'</span>
  <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
         <span class="token operator">^</span><span class="token operator">~</span>
<span class="token punctuation">.</span>\test<span class="token punctuation">.</span>cpp<span class="token operator">:</span><span class="token number">9</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span> note<span class="token operator">:</span> in instantiation of function <span class="token keyword">template</span> specialization       
      <span class="token string">'id&lt;const char *>'</span> requested here
    <span class="token keyword">auto</span> y <span class="token operator">=</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token operator">^</span>
<span class="token number">1</span> error generated<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这诉说了一个无情的真相：C++编译器不会对模板函数进行类型检查，只会在<strong>特化</strong>的时候进行类型检查。而这使得命题1.无法成立，因为我们根本没有保证在<code>T</code>是一个类型，<code>x</code>是<code>T</code>类型的情况下，可以推出<code>id</code>函数体（也就是<code>return x</code>）的类型是<code>T</code>.</p>
<p>相反，ocaml会无视泛型参数：</p>
<pre class="line-numbers language-ocaml" data-language="ocaml"><code class="language-ocaml"># <span class="token keyword">let</span> id <span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token type-variable function">'a</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> int <span class="token operator">=</span> x <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">val</span> id <span class="token punctuation">:</span> int <span class="token operator">-></span> int <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">fun</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-ocaml" data-language="ocaml"><code class="language-ocaml"># <span class="token keyword">let</span> id <span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token type-variable function">'a</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">val</span> id <span class="token punctuation">:</span> int <span class="token operator">-></span> int <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">fun</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Haskell会报错：</p>
<pre class="line-numbers language-haskell" data-language="haskell"><code class="language-haskell"><span class="token constant">Prelude</span><span class="token operator">></span> <span class="token operator">:</span><span class="token punctuation">&#123;</span>
<span class="token constant">Prelude</span><span class="token operator">|</span> <span class="token builtin">id</span> <span class="token operator">::</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">a</span>
<span class="token constant">Prelude</span><span class="token operator">|</span> <span class="token builtin">id</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token number">10</span>
<span class="token constant">Prelude</span><span class="token operator">|</span> <span class="token operator">:</span><span class="token punctuation">&#125;</span>

<span class="token operator">&lt;</span><span class="token hvariable">interactive</span><span class="token operator">>:</span><span class="token number">6</span><span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span> <span class="token builtin">error</span><span class="token operator">:</span>
    • <span class="token constant">No</span> <span class="token keyword">instance</span> <span class="token hvariable">for</span> <span class="token punctuation">(</span><span class="token constant">Num</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token hvariable">arising</span> <span class="token hvariable">from</span> <span class="token hvariable">the</span> <span class="token hvariable">literal</span> ‘<span class="token number">10</span>’
      <span class="token constant">Possible</span> <span class="token hvariable">fix</span><span class="token operator">:</span>
        <span class="token hvariable">add</span> <span class="token punctuation">(</span><span class="token constant">Num</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token hvariable">to</span> <span class="token hvariable">the</span> <span class="token hvariable">context</span> <span class="token keyword">of</span>
          <span class="token hvariable">the</span> <span class="token keyword">type</span> <span class="token hvariable">signature</span> <span class="token hvariable">for</span><span class="token operator">:</span>
            <span class="token builtin">id</span> <span class="token operator">::</span> <span class="token hvariable">forall</span> <span class="token hvariable">a</span><span class="token punctuation">.</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">a</span>
    • <span class="token constant">In</span> <span class="token hvariable">the</span> <span class="token hvariable">expression</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token constant">In</span> <span class="token hvariable">an</span> <span class="token hvariable">equation</span> <span class="token hvariable">for</span> ‘<span class="token builtin">id</span>’<span class="token operator">:</span> <span class="token builtin">id</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-haskell" data-language="haskell"><code class="language-haskell"><span class="token constant">Prelude</span><span class="token operator">></span> <span class="token operator">:</span><span class="token punctuation">&#123;</span>
<span class="token constant">Prelude</span><span class="token operator">|</span> <span class="token builtin">id</span> <span class="token operator">::</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">Int</span>
<span class="token constant">Prelude</span><span class="token operator">|</span> <span class="token builtin">id</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token hvariable">x</span>
<span class="token constant">Prelude</span><span class="token operator">|</span> <span class="token operator">:</span><span class="token punctuation">&#125;</span>

<span class="token operator">&lt;</span><span class="token hvariable">interactive</span><span class="token operator">>:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span> <span class="token builtin">error</span><span class="token operator">:</span>
    • <span class="token constant">Couldn</span>'<span class="token hvariable">t</span> <span class="token hvariable">match</span> <span class="token hvariable">expected</span> <span class="token keyword">type</span> ‘<span class="token constant">Int</span>’ <span class="token hvariable">with</span> <span class="token hvariable">actual</span> <span class="token keyword">type</span> ‘<span class="token hvariable">a</span>’
      ‘<span class="token hvariable">a</span>’ <span class="token hvariable">is</span> <span class="token hvariable">a</span> <span class="token hvariable">rigid</span> <span class="token keyword">type</span> <span class="token hvariable">variable</span> <span class="token hvariable">bound</span> <span class="token hvariable">by</span>
        <span class="token hvariable">the</span> <span class="token keyword">type</span> <span class="token hvariable">signature</span> <span class="token hvariable">for</span><span class="token operator">:</span>
          <span class="token builtin">id</span> <span class="token operator">::</span> <span class="token hvariable">forall</span> <span class="token hvariable">a</span><span class="token punctuation">.</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">Int</span>
        <span class="token hvariable">at</span> <span class="token operator">&lt;</span><span class="token hvariable">interactive</span><span class="token operator">>:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">14</span>
    • <span class="token constant">In</span> <span class="token hvariable">the</span> <span class="token hvariable">expression</span><span class="token operator">:</span> <span class="token hvariable">x</span>
      <span class="token constant">In</span> <span class="token hvariable">an</span> <span class="token hvariable">equation</span> <span class="token hvariable">for</span> ‘<span class="token builtin">id</span>’<span class="token operator">:</span> <span class="token builtin">id</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token hvariable">x</span>
    • <span class="token constant">Relevant</span> <span class="token hvariable">bindings</span> <span class="token hvariable">include</span>
        <span class="token hvariable">x</span> <span class="token operator">::</span> <span class="token hvariable">a</span> <span class="token punctuation">(</span><span class="token hvariable">bound</span> <span class="token hvariable">at</span> <span class="token operator">&lt;</span><span class="token hvariable">interactive</span><span class="token operator">>:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token builtin">id</span> <span class="token operator">::</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">Int</span> <span class="token punctuation">(</span><span class="token hvariable">bound</span> <span class="token hvariable">at</span> <span class="token operator">&lt;</span><span class="token hvariable">interactive</span><span class="token operator">>:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可见，c++并不是参数多态，它的模板系统和ML类语言中的泛型系统完全不在一个层次上。</p>
<h2 id="类型类影响问题吗"><a class="markdownIt-Anchor" href="#类型类影响问题吗"></a> 类型类影响问题吗？</h2>
<p>有人可能会说了，Haskell的类型类不是也会出现“在使用的时候才报错”这一现象吗？比如说</p>
<pre class="line-numbers language-haskell" data-language="haskell"><code class="language-haskell"><span class="token builtin">max</span> <span class="token operator">::</span> <span class="token constant">Ord</span> <span class="token hvariable">p</span> <span class="token operator">=></span> <span class="token hvariable">p</span> <span class="token operator">-></span> <span class="token hvariable">p</span> <span class="token operator">-></span> <span class="token hvariable">p</span>
<span class="token builtin">max</span> <span class="token hvariable">x</span> <span class="token hvariable">y</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token hvariable">y</span> <span class="token operator">></span> <span class="token hvariable">x</span> <span class="token keyword">then</span> <span class="token hvariable">y</span> <span class="token keyword">else</span> <span class="token hvariable">x</span>

<span class="token keyword">data</span> <span class="token constant">X</span> <span class="token operator">=</span> <span class="token constant">I</span> <span class="token operator">|</span> <span class="token constant">J</span>

<span class="token builtin">max</span> <span class="token constant">I</span> <span class="token constant">J</span> <span class="token comment">-- 这里报错</span>
<span class="token comment">-- error:</span>
<span class="token comment">--    • No instance for (Ord X) arising from a use of ‘max’</span>
<span class="token comment">--    • In the expression: max I J</span>
<span class="token comment">--      In an equation for ‘it’: it = max I J</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个错误简单来说，就是自定义类型<code>X</code>没有实现<code>Ord</code>类型类，而<code>max</code>的<strong>类型签名</strong>中需要类型类<code>Ord</code>，所以报错。这和c++模板仍然很不一样。根本性的区别是，在对<code>max I J</code>进行类型检查的时候，只需要<code>max :: Ord p =&gt; p -&gt; p -&gt; p</code>这一个信息就够了，不需要知道<code>max</code>的函数体是什么，更不需要“特化”这个函数，这仍是在类型系统中的推导。</p>
<h2 id="真假泛型性能更好"><a class="markdownIt-Anchor" href="#真假泛型性能更好"></a> 真假泛型？性能更好？</h2>
<p>虽然我很不喜欢java语言，但是java语言的泛型系统（在一般情况下）满足命题1.，它是真正的参数多态。这是因为java泛型的前身–Generic Java（GJ）是由Philip Wadler等真正的编程语言专家设计的。</p>
<p><img src="https://homepages.inf.ed.ac.uk/wadler/gj/gj-front-full.jpg" alt="GJ作者的合照" / loading="lazy"></p>
<p>有人说Java泛型采用了类型擦除，是“假泛型”，这显然是被c++模板的设计影响了。事实上显然参数多态对应的参数类型更有资格把自己叫做“泛型”。c++才是“假泛型”的例子。</p>
<p>c++模板的设计使得module系统变成了一个困难的问题，到了2021年，99.9%的c++程序仍然在使用上古时代的头文件–这一彻头彻尾的垃圾–模拟module系统。</p>
<p>至于性能，所谓的“特化”在编程语言中有两个更强的概念可以替代。</p>
<ul>
<li>部分求值(partial evaluation)</li>
<li>内联(inlining)</li>
</ul>
<p>特化可以看作是一个部分求值的例子。ocaml和Haskell的IR很难打印出来，而F#则可以通过字节码反编译回C#，在<a target="_blank" rel="noopener" href="https://sharplab.io">sharplab</a>中，可以发现</p>
<pre class="line-numbers language-fsharp" data-language="fsharp"><code class="language-fsharp"><span class="token keyword">let</span> <span class="token keyword">select</span> x y <span class="token operator">=</span> x

<span class="token keyword">let</span> select2 <span class="token punctuation">(</span>x<span class="token punctuation">:</span><span class="token class-name">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>y<span class="token punctuation">:</span><span class="token class-name">int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">select</span> x y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这样的例子会得到：</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>FSharp<span class="token punctuation">.</span>Core</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token target keyword">assembly</span><span class="token punctuation">:</span> <span class="token class-name">FSharpInterfaceDataVersion</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token target keyword">assembly</span><span class="token punctuation">:</span> <span class="token class-name">AssemblyVersion</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CompilationMapping</span><span class="token attribute-arguments"><span class="token punctuation">(</span>SourceConstructFlags<span class="token punctuation">.</span>Module<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">@_</span>
<span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CompilationArgumentCounts</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span>
        <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token number">1</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> a <span class="token generic-method"><span class="token function">select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>a<span class="token punctuation">,</span> b<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">a</span> x<span class="token punctuation">,</span> <span class="token class-name">b</span> y<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CompilationArgumentCounts</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span>
        <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token number">1</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">select2</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> x<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> y<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token operator">&lt;</span>StartupCode$_<span class="token operator">></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">class</span> $_
    <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>select2</code>难道不是对<code>select</code>的“特化”吗？由此看来，c++模板的“性能更好”也是很难说清楚的问题。</p>
<h2 id="concept-能解决问题吗"><a class="markdownIt-Anchor" href="#concept-能解决问题吗"></a> concept: 能解决问题吗？</h2>
<p>是否是参数多态，似乎只是一个学术问题。不是参数多态，主要导致的是使用一个参数化类型（parametric type，也就是含有∀的类型）时的潜在错误，pararmetricity不成立，某些定理（比如<code>map f . map g = map (f . g)</code>）也不成立。</p>
<p>之前已经提到了，Haskell也有会出错的问题。其他ML家族的语言，如果不算上类似F#的object系统的扩展，则基本没有出错的问题，但是需要传递更多参数。比如<code>List.sortWith</code>的类型就是<code>(('a -&gt; 'a -&gt; int) -&gt; 'a list -&gt; 'a list)</code>，对于任何<code>'a</code>都不会出错，但是需要显式地传递一个comparer. 所以不是参数多态，可能也不是特别大的问题。</p>
<p>但说到c++，不是参数多态确实带来了一个相当严重的问题，那就是模板系统给出的报错信息常常令人无从下手。</p>
<p>例如这样的程序：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>A<span class="token operator">></span> v<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>会产生200行，19kb的报错：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">In file included from .\test.cpp:3:
C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.28.29910\include\algorithm:7361:32: error: no matching function for call to object of type 'std::less&lt;>'
            if (_DEBUG_LT_PRED(_Pred, _Val, *_First)) &#123; // found new earliest element, move to front
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了解决这个问题，c++20引入了concept，concept借鉴了类型类和java泛型的设计，可以使得我们能写出类似于之前Haskell的<code>max</code>那样的程序：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;concepts></span></span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token keyword">requires</span> std<span class="token double-colon punctuation">::</span>equality_comparable<span class="token operator">&lt;</span>T<span class="token operator">></span>
<span class="token keyword">bool</span> <span class="token function">max</span><span class="token punctuation">(</span>T x<span class="token punctuation">,</span> T y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">></span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> y<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果这时写出：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译器会报错：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">source>: In function 'int main()':
&lt;source>:17:8: error: no matching function for call to 'max(A, A)'
   17 |     max(A(), A());
      |     ~~~^~~~~~~~~~
&lt;source>:6:6: note: candidate: 'template&lt;class T>  requires  equality_comparable&lt;T> bool max(T, T)'
    6 | bool max(T x, T y) &#123;
      |      ^~~
&lt;source>:6:6: note:   template argument deduction/substitution failed:
&lt;source>:6:6: note: constraints not satisfied
In file included from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/compare:39,
                 from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/stl_pair.h:65,
                 from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/stl_algobase.h:64,
                 from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/char_traits.h:39,
                 from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/ios:40,
                 from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/ostream:38,
                 from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/iostream:39,
                 from &lt;source>:1:
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/concepts: In substitution of 'template&lt;class T>  requires  equality_comparable&lt;T> bool max(T, T) [with T = A]':
&lt;source>:17:8:   required from here
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/concepts:280:15:   required for the satisfaction of '__weakly_eq_cmp_with&lt;_Tp, _Tp>' [with _Tp = A]
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/concepts:290:13:   required for the satisfaction of 'equality_comparable&lt;T>' [with T = A]
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/concepts:281:4:   in requirements with 'std::remove_reference_t&lt;_Tp>&amp; __t', 'std::remove_reference_t&lt;_Up>&amp; __u' [with _Up = A; _Tp = A]
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/concepts:282:17: note: the required expression '(__t == __u)' is invalid
  282 |           &#123; __t == __u &#125; -> __boolean_testable;
      |             ~~~~^~~~~~
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/concepts:283:17: note: the required expression '(__t != __u)' is invalid
  283 |           &#123; __t != __u &#125; -> __boolean_testable;
      |             ~~~~^~~~~~
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/concepts:284:17: note: the required expression '(__u == __t)' is invalid
  284 |           &#123; __u == __t &#125; -> __boolean_testable;
      |             ~~~~^~~~~~
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/concepts:285:17: note: the required expression '(__u != __t)' is invalid
  285 |           &#123; __u != __t &#125; -> __boolean_testable;
      |             ~~~~^~~~~~
cc1plus: note: set '-fconcepts-diagnostics-depth=' to at least 2 for more detail
Compiler returned: 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里会直接表明A不满足<code>std::equality_comparable</code>的约束。虽然如此，噪音还是非常的多。更重要的是，对于库函数–这种我们不想研究源码的函数，效果还是一般：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">n file included from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/stl_algobase.h:71,
                 from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/char_traits.h:39,
                 from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/ios:40,
                 from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/ostream:38,
                 from /opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/iostream:39,
                 from &lt;source>:1:
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/predefined_ops.h: In instantiation of 'constexpr bool __gnu_cxx::__ops::_Iter_less_iter::operator()(_Iterator1, _Iterator2) const [with _Iterator1 = __gnu_cxx::__normal_iterator&lt;A*, std::vector&lt;A> >; _Iterator2 = __gnu_cxx::__normal_iterator&lt;A*, std::vector&lt;A> >]':
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/stl_algo.h:1826:14:   required from 'constexpr void std::__insertion_sort(_RandomAccessIterator, _RandomAccessIterator, _Compare) [with _RandomAccessIterator = __gnu_cxx::__normal_iterator&lt;A*, std::vector&lt;A> >; _Compare = __gnu_cxx::__ops::_Iter_less_iter]'
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/stl_algo.h:1866:25:   required from 'constexpr void std::__final_insertion_sort(_RandomAccessIterator, _RandomAccessIterator, _Compare) [with _RandomAccessIterator = __gnu_cxx::__normal_iterator&lt;A*, std::vector&lt;A> >; _Compare = __gnu_cxx::__ops::_Iter_less_iter]'
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/stl_algo.h:1957:31:   required from 'constexpr void std::__sort(_RandomAccessIterator, _RandomAccessIterator, _Compare) [with _RandomAccessIterator = __gnu_cxx::__normal_iterator&lt;A*, std::vector&lt;A> >; _Compare = __gnu_cxx::__ops::_Iter_less_iter]'
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/stl_algo.h:4842:18:   required from 'constexpr void std::sort(_RAIter, _RAIter) [with _RAIter = __gnu_cxx::__normal_iterator&lt;A*, std::vector&lt;A> >]'
&lt;source>:10:14:   required from here
/opt/compiler-explorer/gcc-11.2.0/include/c++/11.2.0/bits/predefined_ops.h:45:23: error: no match for 'operator&lt;' (operand types are 'A' and 'A')
   45 |       &#123; return *__it1 &lt; *__it2; &#125;
      |                ~~~~~~~^~~~~~~~

剩下还有80多行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>事实上，当c++引入模板机制而不进行类型检查的那一刻，这种修修补补也很难解决问题的情形已经被决定了。希望c++模板的引起的种种问题，能够给后世的语言设计者以警醒和教训。</p>
</div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>ayanamists</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://ayanamists.xyz/2021/09/14/parametric-poly/" title="c++模板与参数多态的根本区别">https://ayanamists.xyz/2021/09/14/parametric-poly/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless otherwise stated.</li></ul></section></article><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/08/29/combinator/" rel="next" title="Frege/Hilbert系统与组合子逻辑"><span class="post-nav-text">Frege/Hilbert系统与组合子逻辑</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div><style>.utterances {
  max-width: 100%;
}</style><script src="https://utteranc.es/client.js" repo="ayanamists/ayanamists.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> ayanamists</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.4.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.6.2</span></div><div id="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" title="Total Visitors"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-user-line"></use></svg></span><span id="busuanzi_value_site_uv"></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" title="Total Views"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg></span><span id="busuanzi_value_site_pv"></span></span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#7350B9" stroke-width="2" stroke-linecap="round"></circle></svg></a></div></body></html>