I"Ø#<ul>
  <li><a href="#%e5%89%8d%e8%a8%80">å‰è¨€</a></li>
  <li><a href="#%e6%9f%a5%e6%89%be%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%ae%9a%e4%b9%89">æŸ¥æ‰¾çš„åŸºæœ¬å®šä¹‰</a></li>
  <li><a href="#%e6%9f%a5%e6%89%be%e7%ae%97%e6%b3%95%e7%9a%84%e5%88%86%e6%9e%90%e5%92%8c%e8%ae%be%e8%ae%a1">æŸ¥æ‰¾ç®—æ³•çš„åˆ†æå’Œè®¾è®¡</a></li>
  <li><a href="#%e9%a1%ba%e5%ba%8f%e6%9f%a5%e6%89%be%e7%ae%97%e6%b3%95">é¡ºåºæŸ¥æ‰¾ç®—æ³•</a></li>
  <li><a href="#%e4%ba%8c%e5%88%86%e6%9f%a5%e6%89%be%e7%ae%97%e6%b3%95%e4%b8%8e%e4%ba%8c%e5%8f%89%e6%9f%a5%e6%89%be%e6%a0%91">äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ä¸äºŒå‰æŸ¥æ‰¾æ ‘</a></li>
  <li><a href="#%e5%88%86%e5%9d%97%e6%9f%a5%e6%89%be">åˆ†å—æŸ¥æ‰¾</a></li>
  <li><a href="#%e5%a0%86%e4%bc%98%e5%85%88%e9%98%9f%e5%88%97">å †/ä¼˜å…ˆé˜Ÿåˆ—</a>
    <ul>
      <li><a href="#%e5%a0%86%e7%9a%84%e6%a6%82%e5%bf%b5%e4%b8%8e%e5%ae%9e%e7%8e%b0">å †çš„æ¦‚å¿µä¸å®ç°</a></li>
      <li><a href="#%e5%a0%86%e5%8f%af%e4%bb%a5%e7%94%a8%e6%9d%a5%e5%81%9a%e4%bb%80%e4%b9%88">å †å¯ä»¥ç”¨æ¥åšä»€ä¹ˆï¼Ÿ</a></li>
    </ul>
  </li>
  <li><a href="#%e6%95%a3%e5%88%97%e8%a1%a8">æ•£åˆ—è¡¨</a>
    <ul>
      <li><a href="#%e5%93%88%e5%b8%8c%e8%a1%a8%e7%9a%84%e5%ae%9a%e4%b9%89">å“ˆå¸Œè¡¨çš„å®šä¹‰</a></li>
      <li><a href="#%e5%93%88%e5%b8%8c%e5%87%bd%e6%95%b0">å“ˆå¸Œå‡½æ•°</a></li>
      <li><a href="#%e7%a2%b0%e6%92%9e%e5%a4%84%e7%90%86">ç¢°æ’å¤„ç†</a></li>
      <li><a href="#%e5%93%88%e5%b8%8c%e8%a1%a8%e7%9a%84%e5%ae%9e%e7%8e%b0----%e6%88%91%e5%ae%9e%e7%8e%b0%e7%9a%84c%e7%89%88%e6%9c%ac">å“ˆå¸Œè¡¨çš„å®ç° â€“ æˆ‘å®ç°çš„c++ç‰ˆæœ¬</a></li>
      <li><a href="#ruby%e4%b8%ad%e7%9a%84%e5%93%88%e5%b8%8c%e8%a1%a8%e5%ae%9e%e7%8e%b0">Rubyä¸­çš„å“ˆå¸Œè¡¨å®ç°</a>
        <ul>
          <li><a href="#sttable-%e7%9a%84%e5%93%88%e5%b8%8c%e5%87%bd%e6%95%b0">st_table çš„å“ˆå¸Œå‡½æ•°</a></li>
          <li><a href="#sttable%e7%9a%84%e7%a2%b0%e6%92%9e%e5%a4%84%e7%90%86">st_tableçš„ç¢°æ’å¤„ç†</a></li>
          <li><a href="#sttable%e7%9a%84%e6%89%a9%e5%ae%b9">st_tableçš„æ‰©å®¹</a></li>
          <li><a href="#%e6%80%bb%e7%bb%93">æ€»ç»“</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="å‰è¨€">å‰è¨€</h2>

<p>è¿™ä¸€ç« ï¼Œæˆ‘ä»¬å­¦ä¹ äº†æŸ¥æ‰¾è¿™ç§åŸºæœ¬æ“ä½œå’Œå †ã€æ•£åˆ—è¡¨è¿™ä¸¤ç§éå¸¸é‡è¦çš„æ•°æ®ç»“æ„ã€‚
æœ¬ç¬”è®°ä¸»è¦å®Œæˆäº†ä»¥ä¸‹å·¥ä½œï¼š</p>

<ul>
  <li>æ€»ç»“äº†å…³äºæŸ¥æ‰¾çš„å„ç§çŸ¥è¯†ç‚¹</li>
  <li>ç”¨rubyè¯­è¨€å®ç°äº†ä¸€ä¸ªç®€å•çš„å †æ¨¡å—(è¿™é‡Œçš„æ¨¡å—æŒ‡moduleï¼Œæ˜¯rubyä¸­MIX_INæ€æƒ³çš„ä¸»è¦å®ç°æ¨¡å¼ï¼Œä¸‹é¢ä¼šåšç®€çŸ­ä»‹ç»)ï¼Œå¹¶è¿›è¡Œäº†ç®€å•æµ‹è¯•</li>
  <li>ç”¨C++è¯­è¨€å®ç°äº†ä¸€ä¸ªç®€å•çš„å“ˆå¸Œè¡¨ï¼Œå¹¶è¿›è¡Œäº†ç®€å•æµ‹è¯•</li>
  <li>è®¨è®ºäº†rubyä¸­å“ˆå¸Œè¡¨çš„å®ç°</li>
  <li>è®¨è®ºäº†stlä¸­std::find, std::binary_searchç­‰å‡½æ•°çš„å®ç°</li>
</ul>

<h2 id="æŸ¥æ‰¾çš„åŸºæœ¬å®šä¹‰">æŸ¥æ‰¾çš„åŸºæœ¬å®šä¹‰</h2>

<p>æŸ¥æ‰¾ä¹Ÿå¯ä»¥è§†ä¸ºæœç´¢ï¼Œwikipediaå¯¹æœç´¢çš„å®šä¹‰æ˜¯ï¼š</p>
<blockquote>
  <p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæœç´¢ç®—æ³•æ˜¯è§£å†³æœç´¢é—®é¢˜çš„ä»»ä½•ç®—æ³•ï¼Œå³æ£€ç´¢å­˜å‚¨åœ¨æŸä¸ªæ•°æ®ç»“æ„ä¸­çš„ä¿¡æ¯ï¼Œæˆ–è€…åœ¨é—®é¢˜åŸŸçš„æœç´¢ç©ºé—´ä¸­è®¡ç®—çš„ä¿¡æ¯ã€‚
å…¶å®ç®€å•æ¥è¯´ï¼ŒæŸ¥æ‰¾å°±æ˜¯â€œæ‰¾ä¸œè¥¿â€ã€‚</p>
</blockquote>

<p>è€Œæˆ‘ä»¬è¦æ‰¾çš„â€œä¸œè¥¿â€ï¼Œä¸¥æ ¼æ¥è¯´åº”è¯¥å«åšâ€œå…³é”®å­—â€ï¼Œæˆ–è€…æ›´å­¦æœ¯ä¸€äº›ï¼Œå«åšâ€œé”®â€ã€‚æ‰¾åˆ°â€œé”®â€ä¹‹åï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªâ€œé”®-å€¼æ˜ å°„â€ï¼Œå°±å¯ä»¥å¾—åˆ°å…¶â€œå€¼â€ã€‚</p>

<h2 id="æŸ¥æ‰¾ç®—æ³•çš„åˆ†æå’Œè®¾è®¡">æŸ¥æ‰¾ç®—æ³•çš„åˆ†æå’Œè®¾è®¡</h2>

<p>æŸ¥æ‰¾ç®—æ³•å®é™…ä¸ŠåŒ…å«ä¸‰ä¸ªå±‚æ¬¡çš„é—®é¢˜ï¼š</p>

<ol>
  <li>åœ¨ä»€ä¹ˆæ•°æ®ç»“æ„ä¸ŠæŸ¥æ‰¾</li>
  <li>å¦‚ä½•æŸ¥æ‰¾</li>
  <li>æŸ¥æ‰¾çš„æ•ˆç‡å¦‚ä½•</li>
</ol>

<h2 id="é¡ºåºæŸ¥æ‰¾ç®—æ³•">é¡ºåºæŸ¥æ‰¾ç®—æ³•</h2>

<p>é¡ºåºæŸ¥æ‰¾æ˜¯æœ€æœ´ç´ çš„æŸ¥æ‰¾ï¼Œå¯ä»¥ç”¨åœ¨å„ç§çº¿æ€§è¡¨ä¸Šã€‚åœ¨MSVCçš„stlä¸­ï¼Œæˆ‘ä»¬æœ‰std::findå‡½æ•°å®ç°è¿™ä¸ªç®—æ³•ï¼š</p>

<p><em>ä»¥ä¸‹ä»£ç æ¥è‡ª&lt;algorithm&gt;</em></p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_InIt</span><span class="p">,</span> <span class="k">class</span> <span class="nc">_Ty</span><span class="p">&gt;</span>
<span class="n">_NODISCARD</span> <span class="kr">inline</span> <span class="n">_InIt</span> <span class="nf">find</span><span class="p">(</span><span class="n">_InIt</span> <span class="n">_First</span><span class="p">,</span> <span class="k">const</span> <span class="n">_InIt</span> <span class="n">_Last</span><span class="p">,</span> <span class="k">const</span> <span class="n">_Ty</span><span class="o">&amp;</span> <span class="n">_Val</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// find first matching _Val</span>
    <span class="n">_Adl_verify_range</span><span class="p">(</span><span class="n">_First</span><span class="p">,</span> <span class="n">_Last</span><span class="p">);</span>
    <span class="n">_Seek_wrapped</span><span class="p">(</span><span class="n">_First</span><span class="p">,</span> <span class="n">_Find_unchecked</span><span class="p">(</span><span class="n">_Get_unwrapped</span><span class="p">(</span><span class="n">_First</span><span class="p">),</span> <span class="n">_Get_unwrapped</span><span class="p">(</span><span class="n">_Last</span><span class="p">),</span> <span class="n">_Val</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">_First</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>_Adl_verify_rangeæ˜¯æ£€æŸ¥å‚æ•°èŒƒå›´æ˜¯å¦æœ‰æ•ˆï¼Œ_Seek_wrappedå‡½æ•°ç®€å•æ¥è¯´æ˜¯æŠŠåä¸€ä¸ªå‚æ•°çš„å€¼èµ‹ç»™å‰ä¸€ä¸ªå‚æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_Ty</span><span class="p">&gt;</span>
<span class="k">constexpr</span> <span class="kt">void</span> <span class="nf">_Seek_wrapped</span><span class="p">(</span><span class="n">_Ty</span><span class="o">*&amp;</span> <span class="n">_It</span><span class="p">,</span> <span class="n">_Ty</span><span class="o">*</span> <span class="k">const</span> <span class="n">_UIt</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_It</span> <span class="o">=</span> <span class="n">_UIt</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å®é™…æŸ¥æ‰¾è¿‡ç¨‹åœ¨_Find_uncheckedå‡½æ•°ä¸­ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_InIt</span><span class="p">,</span> <span class="k">class</span> <span class="nc">_Ty</span><span class="p">&gt;</span>
<span class="kr">inline</span> <span class="n">_InIt</span> <span class="nf">_Find_unchecked</span><span class="p">(</span><span class="k">const</span> <span class="n">_InIt</span> <span class="n">_First</span><span class="p">,</span> <span class="k">const</span> <span class="n">_InIt</span> <span class="n">_Last</span><span class="p">,</span> <span class="k">const</span> <span class="n">_Ty</span><span class="o">&amp;</span> <span class="n">_Val</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// find first matching _Val; choose optimization</span>
    <span class="c1">// activate optimization for pointers to (const) bytes and integral values</span>
    <span class="k">using</span> <span class="n">_Memchr_opt</span> <span class="o">=</span> <span class="n">bool_constant</span><span class="o">&lt;</span>
        <span class="n">is_integral_v</span><span class="o">&lt;</span><span class="n">_Ty</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span> <span class="n">_Is_any_of_v</span><span class="o">&lt;</span><span class="n">_InIt</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="kt">signed</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="c1">//</span>
            <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">signed</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*&gt;&gt;</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">_Find_unchecked1</span><span class="p">(</span><span class="n">_First</span><span class="p">,</span> <span class="n">_Last</span><span class="p">,</span> <span class="n">_Val</span><span class="p">,</span> <span class="n">_Memchr_opt</span><span class="p">{});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è€Œè¿™ä¸ªå‡½æ•°å®é™…ä¸Šåˆè°ƒç”¨äº†_Find_unchecked1å‡½æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_InIt</span><span class="p">,</span> <span class="k">class</span> <span class="nc">_Ty</span><span class="p">&gt;</span>
<span class="kr">inline</span> <span class="n">_InIt</span> <span class="nf">_Find_unchecked1</span><span class="p">(</span><span class="n">_InIt</span> <span class="n">_First</span><span class="p">,</span> <span class="k">const</span> <span class="n">_InIt</span> <span class="n">_Last</span><span class="p">,</span> <span class="k">const</span> <span class="n">_Ty</span><span class="o">&amp;</span> <span class="n">_Val</span><span class="p">,</span> <span class="n">false_type</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// find first matching _Val</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">_First</span> <span class="o">!=</span> <span class="n">_Last</span><span class="p">;</span> <span class="o">++</span><span class="n">_First</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">_First</span> <span class="o">==</span> <span class="n">_Val</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">_First</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è°¢å¤©è°¢åœ°ï¼Œ_Find_unchecked1å‡½æ•°å°±æ˜¯ä¸»è¦å®ç°äº†ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ªè¿‡ç¨‹éå¸¸ç®€å•ï¼Œå°±æ˜¯é¡ºåºåœ°æŸ¥æ‰¾æ•´ä¸ªè¡¨ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±é€€å‡ºã€‚</p>

<p>ç”±äºæ¨¡æ¿çš„å­˜åœ¨ï¼Œåœ¨c++ä¸­ï¼Œåªè¦å®šä¹‰äº†è¿­ä»£å™¨ï¼Œä¸€ä¸ªç±»å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°è¿›è¡ŒæŸ¥æ‰¾ã€‚è¿™ä¹Ÿæ­£æ˜¯å¯¹æˆ‘ä»¬æŠ½è±¡æè¿°â€“æŸ¥æ‰¾çº¿æ€§è¡¨â€“çš„æŠ½è±¡å®ç°ã€‚</p>

<p>å¦‚æœå‡è®¾ç­‰æ¦‚ç‡ï¼Œè¿™ä¸ªç®—æ³•æœ‰</p>

<p>\(ASL_{success} = \frac{n + 1}{2}\)
\(ASL_{fail} = n + 1\)</p>

<h2 id="äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ä¸äºŒå‰æŸ¥æ‰¾æ ‘">äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ä¸äºŒå‰æŸ¥æ‰¾æ ‘</h2>
<p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œé¡ºåºæŸ¥æ‰¾æŸ¥æ‰¾ä¸€æ¬¡çš„æ—¶é—´å¤æ‚åº¦æ˜¯$O(n)$çš„ã€‚å¯ä¸å¯ä»¥æœ‰æ›´å¥½çš„æ•ˆç‡å‘¢ï¼Ÿ</p>

<p>å¦‚æœå‡å®šé¡ºåºè¡¨æ˜¯æœ‰åºçš„ï¼Œé‚£ä¹ˆæ€è€ƒè¿™æ ·çš„ç»“è®ºï¼š</p>

<blockquote>
  <p>å¦‚æœå¾…æŸ¥è¯¢çš„å…ƒç´ å¤§äº $array[floor(n / 2)]$ï¼Œé‚£ä¹ˆï¼Œå®ƒä¸€å®šå¤§äº$array[0]$åˆ°$array[floor(n / 2) - 1]$çš„æ‰€æœ‰å…ƒç´ ã€‚</p>
</blockquote>

<p>è¿™æ ·ä¸€æ¥ï¼Œä¸‹ä¸€æ¬¡çš„æŸ¥è¯¢å°±å¯ä»¥ä¸ç®¡è¿™äº›å…ƒç´ ï¼Œç›´æ¥æŸ¥è¯¢$array[floor(n/2) + 1]$åˆ°$array[n - 1]$è¿™ä¸ªåŒºé—´äº†ã€‚</p>

<p>è¿™å®é™…ä¸Šå·²ç»æ˜¯ä¸€ä¸ªé€’å½’ç®—æ³•äº†ã€‚è¿™ä¸ªç®—æ³•çš„å®ç°å¾ˆç®€å•ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯æ¥ç ”ç©¶ä¸€ä¸‹c++ stlä¸­std::binary_searchçš„å®ç°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_FwdIt</span><span class="p">,</span> <span class="k">class</span> <span class="nc">_Ty</span><span class="p">&gt;</span>
<span class="n">_NODISCARD</span> <span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">binary_search</span><span class="p">(</span>
    <span class="n">_FwdIt</span> <span class="n">_First</span><span class="p">,</span> <span class="n">_FwdIt</span> <span class="n">_Last</span><span class="p">,</span> <span class="k">const</span> <span class="n">_Ty</span><span class="o">&amp;</span> <span class="n">_Val</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// test if _Val equivalent to some element, using operator&lt;</span>
    <span class="k">return</span> <span class="n">_STD</span> <span class="n">binary_search</span><span class="p">(</span><span class="n">_First</span><span class="p">,</span> <span class="n">_Last</span><span class="p">,</span> <span class="n">_Val</span><span class="p">,</span> <span class="n">less</span><span class="o">&lt;&gt;</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸‹é¢è¿™ä¸ªbinary_searchæ˜¯ä¸€ä¸ªé‡è½½çš„å‡½æ•°ï¼Œå®ƒæ‰æ˜¯çœŸæ­£ç”¨æ¥å®ç°çš„å‡½æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// FUNCTION TEMPLATE binary_search</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_FwdIt</span><span class="p">,</span> <span class="k">class</span> <span class="nc">_Ty</span><span class="p">,</span> <span class="k">class</span> <span class="nc">_Pr</span><span class="p">&gt;</span>
<span class="n">_NODISCARD</span> <span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">binary_search</span><span class="p">(</span>
    <span class="n">_FwdIt</span> <span class="n">_First</span><span class="p">,</span> <span class="n">_FwdIt</span> <span class="n">_Last</span><span class="p">,</span> <span class="k">const</span> <span class="n">_Ty</span><span class="o">&amp;</span> <span class="n">_Val</span><span class="p">,</span> <span class="n">_Pr</span> <span class="n">_Pred</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// test if _Val equivalent to some element, using _Pred</span>
    <span class="n">_Adl_verify_range</span><span class="p">(</span><span class="n">_First</span><span class="p">,</span> <span class="n">_Last</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">_UFirst</span>      <span class="o">=</span> <span class="n">_Get_unwrapped</span><span class="p">(</span><span class="n">_First</span><span class="p">);</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">_ULast</span> <span class="o">=</span> <span class="n">_Get_unwrapped</span><span class="p">(</span><span class="n">_Last</span><span class="p">);</span>
    <span class="n">_UFirst</span>           <span class="o">=</span> <span class="n">_STD</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">_UFirst</span><span class="p">,</span> <span class="n">_ULast</span><span class="p">,</span> <span class="n">_Val</span><span class="p">,</span> <span class="n">_Pass_fn</span><span class="p">(</span><span class="n">_Pred</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">_UFirst</span> <span class="o">!=</span> <span class="n">_ULast</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_Pred</span><span class="p">(</span><span class="n">_Val</span><span class="p">,</span> <span class="o">*</span><span class="n">_UFirst</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™çœ‹èµ·æ¥å¹¶ä¸æ˜¯ç›´æ¥é€’å½’ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸€ä¸ªlower_boundå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿæ˜¾ç„¶çš„ï¼Œlower_boundçš„æ„æ€æ˜¯ä¸‹ç•Œï¼Œå®ƒå®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// FUNCTION TEMPLATE lower_bound</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_FwdIt</span><span class="p">,</span> <span class="k">class</span> <span class="nc">_Ty</span><span class="p">,</span> <span class="k">class</span> <span class="nc">_Pr</span><span class="p">&gt;</span>
<span class="n">_NODISCARD</span> <span class="kr">inline</span> <span class="n">_FwdIt</span> <span class="nf">lower_bound</span><span class="p">(</span><span class="n">_FwdIt</span> <span class="n">_First</span><span class="p">,</span> <span class="k">const</span> <span class="n">_FwdIt</span> <span class="n">_Last</span><span class="p">,</span> <span class="k">const</span> <span class="n">_Ty</span><span class="o">&amp;</span> <span class="n">_Val</span><span class="p">,</span> <span class="n">_Pr</span> <span class="n">_Pred</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// find first element not before _Val, using _Pred</span>
    <span class="n">_Adl_verify_range</span><span class="p">(</span><span class="n">_First</span><span class="p">,</span> <span class="n">_Last</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">_UFirst</span>                <span class="o">=</span> <span class="n">_Get_unwrapped</span><span class="p">(</span><span class="n">_First</span><span class="p">);</span>
    <span class="n">_Iter_diff_t</span><span class="o">&lt;</span><span class="n">_FwdIt</span><span class="o">&gt;</span> <span class="n">_Count</span> <span class="o">=</span> <span class="n">_STD</span> <span class="n">distance</span><span class="p">(</span><span class="n">_UFirst</span><span class="p">,</span> <span class="n">_Get_unwrapped</span><span class="p">(</span><span class="n">_Last</span><span class="p">));</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">_Count</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// divide and conquer, find half that contains answer</span>
        <span class="k">const</span> <span class="n">_Iter_diff_t</span><span class="o">&lt;</span><span class="n">_FwdIt</span><span class="o">&gt;</span> <span class="n">_Count2</span> <span class="o">=</span> <span class="n">_Count</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// TRANSITION, VSO#433486</span>
        <span class="k">const</span> <span class="k">auto</span> <span class="n">_UMid</span>                   <span class="o">=</span> <span class="n">_STD</span> <span class="n">next</span><span class="p">(</span><span class="n">_UFirst</span><span class="p">,</span> <span class="n">_Count2</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_Pred</span><span class="p">(</span><span class="o">*</span><span class="n">_UMid</span><span class="p">,</span> <span class="n">_Val</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// try top half</span>
            <span class="n">_UFirst</span> <span class="o">=</span> <span class="n">_Next_iter</span><span class="p">(</span><span class="n">_UMid</span><span class="p">);</span>
            <span class="n">_Count</span> <span class="o">-=</span> <span class="n">_Count2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">_Count</span> <span class="o">=</span> <span class="n">_Count2</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">_Seek_wrapped</span><span class="p">(</span><span class="n">_First</span><span class="p">,</span> <span class="n">_UFirst</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">_First</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒéº»çƒ¦ï¼Œå®ƒè¿”å›çš„æ˜¯ç¬¬ä¸€ä¸ªä¸æ»¡è¶³_Predæ¡ä»¶çš„å…ƒç´ ã€‚è¿™é‡Œ_Predæ¡ä»¶æ˜¯&lt;ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯ç¬¬ä¸€ä¸ªå¤§äºç­‰äºè¿™ä¸ªå…ƒç´ çš„è¿­ä»£å™¨ï¼Œ
ç„¶åbinary_searchå‡½æ•°å°±ç”¨!(_Pred(_Val, *_Ufirst))è¿™ä¸ªæ¡ä»¶æ¥åˆ¤æ–­æ˜¯å¦ç›¸ç­‰ï¼Œè¿™ç›¸å½“äºæ„é€ äº†
\(a &gt;= b\)
\(a &lt;= b\)
æ˜¾ç„¶åœ°ï¼Œåªæœ‰å½“$a == b$æ—¶ï¼Œè¡¨è¾¾å¼æ‰è¿”å›çœŸï¼ˆåæ§½ä¸€ä¸‹ï¼Œè¿™stlå†™çš„å¤ªâ€œèªæ˜â€äº†ï¼‰</p>

<p>åœ¨äºŒåˆ†æŸ¥æ‰¾ä¸­ï¼ŒæˆåŠŸæŸ¥æ‰¾æ—¶çš„ASLä¸ºï¼š
\(\sum{i * P(i)} = 1/n*( \sum_{1}^{floor(log(n))}{i * 2^{i}} + ceil(log(n)) * (n - floor(log(n))))\)
è¿™ä¸ªå¼å­è¿‡äºç¹çï¼Œæˆ‘ä»¬å‡è®¾å®ƒçš„äºŒå‰åˆ¤å®šæ ‘ä¸ºæ»¡äºŒå‰æ ‘ï¼Œå¯ä»¥å¾—åˆ°ï¼š
\({n - 1}/{n} * log(n + 1) - 1\)</p>

<h2 id="åˆ†å—æŸ¥æ‰¾">åˆ†å—æŸ¥æ‰¾</h2>

<p>åˆ†å—æŸ¥æ‰¾é‡‡ç”¨äº†å—é—´æœ‰åºï¼Œå—å†…æ— åºçš„åŸºæœ¬æ€æƒ³ï¼Œå»ºç«‹ä¸€ä¸ªç´¢å¼•è¡¨è®°å½•å—å†…çš„æœ€å¤§å€¼æˆ–æœ€å°å€¼ï¼Œç„¶åå…ˆæŸ¥ç´¢å¼•è¡¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„å—ï¼Œç„¶åå†åˆ°å—ä¸­æŸ¥è¯¢ã€‚</p>

<p>stlä¸­çš„dequeå®ç°æœ‰è¿™ç§æ€æƒ³çš„å½±å­ã€‚</p>

<h2 id="å †ä¼˜å…ˆé˜Ÿåˆ—">å †/ä¼˜å…ˆé˜Ÿåˆ—</h2>

<h3 id="å †çš„æ¦‚å¿µä¸å®ç°">å †çš„æ¦‚å¿µä¸å®ç°</h3>

<p>å †è¿™ä¸ªè¯æ¥è‡ªäºheapã€‚æˆ‘ä»¬æœ€å…ˆå­¦ä¹ åˆ°çš„heapï¼ŒæŒ‡çš„æ˜¯Cç¨‹åºè¿è¡Œæ—¶ç¯å¢ƒçš„ä¸€éƒ¨åˆ†â€“å†…å­˜åŠ¨æ€åˆ†é…å™¨åŠå…¶åˆ†é…çš„ç©ºé—´ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨mallocå‡½æ•°ã€newå‡½æ•°ï¼ˆnewå®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼‰æ—¶éƒ½è¦ç”¨åˆ°å®ƒæ¥åˆ†é…ç©ºé—´ã€‚</p>

<p>ä½†æ˜¯è¿™é‡Œçš„heapï¼ŒæŒ‡çš„æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>

<ul>
  <li>åˆ†ä¸ºå°é¡¶å †å’Œå¤§é¡¶å †</li>
  <li>å¯¹è‡ª$0$è‡³$floor(n/2) - 1$çš„å…ƒç´ $heap[i]$æœ‰
  \(heap[i] &lt;= heap[2i + 1]\)
  \(heap[i] &lt;= heap[2i + 2]\)</li>
</ul>

<p>å…¶å®ï¼Œç¬¬äºŒä¸ªç‰¹ç‚¹è¡¨æ˜å †å¯ä»¥åŒ–ä¸ºä¸€é¢—äºŒå‰æ ‘ï¼Œè¿™é¢—äºŒå‰æ ‘çš„çˆ¶äº²èŠ‚ç‚¹éƒ½å¤§äºå®ƒçš„å­èŠ‚ç‚¹ã€‚</p>

<p>æˆ‘ä»¬è¿™é‡Œç”¨rubyè¯­è¨€å®ç°äº†ä¸€ä¸ªç®€å•çš„å †ï¼š</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">BinaryHeapable</span>
  <span class="k">def</span> <span class="nf">insert_to_heap</span> <span class="n">element</span>
    <span class="n">target</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">length</span>
    <span class="k">while</span> <span class="nb">self</span><span class="p">[</span><span class="n">target</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">element</span> <span class="o">&amp;&amp;</span> <span class="n">target</span> <span class="o">!=</span> <span class="mi">0</span>
      <span class="nb">self</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="nb">self</span><span class="p">[</span><span class="n">target</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
      <span class="n">target</span> <span class="o">/=</span> <span class="mi">2</span>
    <span class="k">end</span>
    <span class="nb">self</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">remove_from_heap</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="nb">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">pop</span>
    <span class="n">heap_construct</span> <span class="mi">0</span>
    <span class="n">ret</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">convert_to_heap</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">length</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span>
      <span class="n">heap_construct</span> <span class="n">i</span>
      <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="nb">self</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">heap_construct</span> <span class="n">target</span>
    <span class="n">what</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">length</span>
      <span class="k">if</span> <span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">length</span>
        <span class="n">what</span> <span class="o">=</span> <span class="nb">self</span><span class="p">[</span><span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">self</span><span class="p">[</span><span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="p">?</span> <span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="k">else</span>
        <span class="n">what</span> <span class="o">=</span> <span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">end</span>
      <span class="k">break</span> <span class="k">if</span> <span class="nb">self</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">self</span><span class="p">[</span><span class="n">what</span><span class="p">]</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="nb">self</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
      <span class="nb">self</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="nb">self</span><span class="p">[</span><span class="n">what</span><span class="p">]</span>
      <span class="nb">self</span><span class="p">[</span><span class="n">what</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">what</span>
    <span class="k">end</span>
    <span class="n">what</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>ruby ä¸­çš„moduleæ˜¯mix-inæ€æƒ³çš„è½½ä½“ã€‚åªè¦æˆ‘ä»¬è®©ä¸€ä¸ªç±»includeè¿™ä¸ªæ¨¡å—ï¼Œè¿™ä¸ªç±»å°±è·å¾—äº†â€œå †åŒ–â€çš„èƒ½åŠ›ã€‚ç‰¹åˆ«åœ°ï¼Œrubyçš„æ•°ç»„è¢«å°è£…ä¸ºArrayç±»ï¼Œè€Œæ‰€æœ‰çš„è‡ªå¸¦ç±»éƒ½æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼š</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Array</span>
  <span class="kp">include</span> <span class="no">BinaryHeapable</span>
<span class="k">end</span> 
</code></pre></div></div>

<p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹æ³•ä½¿ç”¨æ•°ç»„ï¼š</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">convert_to_heap</span>

<span class="k">while</span> <span class="n">arr</span><span class="p">.</span><span class="nf">length</span> <span class="o">!=</span> <span class="mi">0</span>
  <span class="n">pp</span> <span class="n">arr</span><span class="p">.</span><span class="nf">remove_from_heap</span>
  <span class="n">pp</span> <span class="n">arr</span>
<span class="k">end</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç ä¼šæ‰“å‡ºï¼š</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">8</span>
<span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="mi">6</span>
<span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="mi">5</span>
<span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="mi">3</span>
<span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="mi">3</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="mi">1</span>
<span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="mi">0</span>
<span class="p">[]</span>
</code></pre></div></div>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œå †åªéœ€è¦å®ç°ä¸€ä¸ªæ“ä½œï¼Œå°±å¯ä»¥æå®šå»ºå †å’Œå–å‡ºå †é¡¶ã€‚</p>

<p>è¿™ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯å¦‚ä¸‹çš„æ“ä½œï¼š</p>

<p>å‡è®¾ä¸€ä¸ªå †èŠ‚ç‚¹çš„å·¦å­æ ‘ä¸å³å­æ ‘å‡å·²ç»æ»¡è¶³å †åºï¼ŒæŠŠä»¥è¿™ä¸ªå †èŠ‚ç‚¹ä¸ºæ ¹çš„å­æ ‘è°ƒæ•´æˆå †åºã€‚</p>

<p>è¿™ä¸ªæ“ä½œå®ç°èµ·æ¥å¾ˆç®€å•ï¼Œå…·ä½“å¯å‚åŠ ä»£ç ã€‚</p>

<p>å®ç°äº†è¿™ä¸ªæ“ä½œåï¼Œ</p>

<ul>
  <li>å»ºå †å°±æ˜¯è‡ª$floor(n/2) - 1$è‡³$0$è°ƒç”¨è¿™ä¸ªæ“ä½œï¼›</li>
  <li>å–å‡ºå †é¡¶å°±æ˜¯å…ˆå°†å †é¡¶ç¼“å­˜ï¼Œå†å°†å †å°¾å’Œå †é¡¶äº¤æ¢ï¼Œå†å¯¹å †é¡¶è°ƒç”¨è¿™ä¸ªæ“ä½œã€‚</li>
</ul>

<h3 id="å †å¯ä»¥ç”¨æ¥åšä»€ä¹ˆ">å †å¯ä»¥ç”¨æ¥åšä»€ä¹ˆï¼Ÿ</h3>

<p>å †å¯ä»¥åœ¨$O(log(n))$çš„æ—¶é—´å¤æ‚åº¦å†…å®Œæˆå–å‡ºæœ€å¤§/æœ€å°å…ƒç´ å¹¶è°ƒæ•´ï¼Œè¿™ä¸€ç‰¹æ€§å¯ä»¥ä½œä»¥ä¸‹ç”¨é€”ï¼š</p>

<ul>
  <li>å †æ’åº</li>
  <li>å †ä¼˜åŒ–Dijkstraå’ŒPrimç®—æ³•</li>
  <li>éœå¤«æ›¼æ ‘çš„å®ç°</li>
  <li>etc</li>
</ul>

<h2 id="æ•£åˆ—è¡¨">æ•£åˆ—è¡¨</h2>

<h3 id="å“ˆå¸Œè¡¨çš„å®šä¹‰">å“ˆå¸Œè¡¨çš„å®šä¹‰</h3>

<p>æ•£åˆ—è¡¨ï¼Œåˆç§°å“ˆå¸Œè¡¨ï¼Œæ˜¯ä¸€ç§æä¸ºé‡è¦çš„æ•°æ®ç»“æ„ã€‚</p>

<p>ä¸ºä»€ä¹ˆæå…¶é‡è¦å‘¢ï¼Ÿå› ä¸º</p>

<ul>
  <li>ä¸Šæ–‡æåˆ°çš„rubyï¼Œå…¶å†…éƒ¨æ•°æ®ç»“æ„æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ç”¨æ•£åˆ—è¡¨å®ç°çš„ã€‚</li>
  <li>æ•£åˆ—è¡¨å¯ä»¥ç”¨æ¥å»ºç«‹æ˜ å°„ï¼Œä¾‹å¦‚æŠŠä¸€ä¸ªå­—ç¬¦ä¸²æ˜ å°„åˆ°ä¸€ä¸ªæ•´æ•°ä¸Šï¼Œè¿™å¯¹æŸäº›æƒ…å†µæ˜¯æä¸ºæœ‰ç”¨çš„(ä¾‹å¦‚å›¾ç»“æ„ç¬”è®°ä¸­å®ç°çš„IndexMappingç±»)ã€‚</li>
</ul>

<p>æ•£åˆ—è¡¨çš„å®šä¹‰ä¸ºï¼š</p>
<blockquote>
  <p>æ•£åˆ—è¡¨ï¼ˆHash tableï¼Œä¹Ÿå«å“ˆå¸Œè¡¨ï¼‰ï¼Œæ˜¯æ ¹æ®é”®ï¼ˆKeyï¼‰è€Œç›´æ¥è®¿é—®åœ¨å†…å­˜å­˜å‚¨ä½ç½®çš„æ•°æ®ç»“æ„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒé€šè¿‡è®¡ç®—ä¸€ä¸ªå…³äºé”®å€¼çš„å‡½æ•°ï¼Œå°†æ‰€éœ€æŸ¥è¯¢çš„æ•°æ®æ˜ å°„åˆ°è¡¨ä¸­ä¸€ä¸ªä½ç½®æ¥è®¿é—®è®°å½•ï¼Œè¿™åŠ å¿«äº†æŸ¥æ‰¾é€Ÿåº¦ã€‚è¿™ä¸ªæ˜ å°„å‡½æ•°ç§°åšæ•£åˆ—å‡½æ•°ï¼Œå­˜æ”¾è®°å½•çš„æ•°ç»„ç§°åšæ•£åˆ—è¡¨ã€‚</p>
</blockquote>

<h3 id="å“ˆå¸Œå‡½æ•°">å“ˆå¸Œå‡½æ•°</h3>

<p>é¦–å…ˆå¿…é¡»æ˜ç¡®ï¼Œè¿™é‡Œçš„å“ˆå¸Œå‡½æ•°å’Œå¯†ç å­¦ä¸­çš„å“ˆå¸Œå‡½æ•°å®è´¨æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä¸€ä¸ªæ˜ å°„ï¼š</p>
<blockquote>
  <p>A hash function is any function that can be used to map data of arbitrary size to fixed-size values.</p>
</blockquote>

<p>ä½†æ˜¯ï¼Œè¿™é‡Œçš„å“ˆå¸Œå‡½æ•°å’Œå¯†ç å­¦ä¸­çš„å“ˆå¸Œå‡½æ•°ä¾§é‡ç‚¹æ˜¯ä¸ä¸€æ ·çš„ï¼š</p>

<p>å¯†ç å­¦ä¸­çš„å“ˆå¸Œå‡½æ•°ä¸»è¦è¦æ±‚ä¸¤ä¸ªæ€§è´¨ï¼š</p>

<ol>
  <li>å‡åŒ€æ€§ï¼Œæ‰€æœ‰çš„è¾“å‡ºæ˜¯<em>ç­‰æ¦‚ç‡</em>çš„</li>
  <li>å”¯ä¸€æ€§ï¼Œè¦æ±‚å•å°„ï¼Œå³æ˜¯è¯´ä¸èƒ½å­˜åœ¨$a,b$ï¼Œä½¿å¾—$f(a) == f(b)$</li>
</ol>

<p>é«˜æ•ˆæ€§ï¼ˆé€Ÿåº¦ï¼‰è™½ç„¶å¾ˆé‡è¦ï¼Œä½†è¿œè¿œæ²¡æœ‰ä¸Šé¢ä¸¤æ¡é‡è¦</p>

<p>è€Œè¿™é‡Œçš„å“ˆå¸Œå‡½æ•°åˆ™è¦æ±‚é«˜æ•ˆæ€§ï¼Œå› ä¸ºæˆ‘ä»¬è®¿é—®å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ å¯èƒ½æ˜¯å¾ˆé¢‘ç¹çš„ã€‚</p>

<p>æ‰€ä»¥å¯†ç å­¦ä¸­çš„å“ˆå¸Œå‡½æ•°ç”¨åœ¨è¿™é‡Œæ˜¯ä¸å¤ªåˆé€‚çš„ã€‚</p>

<p>æ•™å¸ˆè®²è¿°äº†6ç§æ–¹æ³•ï¼Œå‡ä»¥æ•´æ•°ä¸ºé”®ï¼š</p>

<ol>
  <li>ç›´æ¥å®šå€æ³•(Identity hash function)ï¼Œæ‰¾ä¸€ä¸ªæ•´æ•°åˆ°æ•´æ•°çš„çº¿æ€§å˜æ¢</li>
  <li>æŠ˜å æ³•(Folding)ï¼Œå°†æ•´æ•°åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½æ˜¯ç›®æ ‡é•¿åº¦çš„å€æ•°ï¼ˆæœ€åä¸€éƒ¨åˆ†å¯ä»¥å°äºç›®æ ‡é•¿åº¦ï¼‰ï¼Œç„¶åå°†è¿™å‡ éƒ¨åˆ†ä½œè¿ç®—ï¼ˆåŠ ã€ç§»ä½ã€å¼‚æˆ–ç­‰ç­‰ï¼‰ï¼Œå¾—åˆ°ç»“æœä¹‹åå–ç›®æ ‡é•¿åº¦ä½ç»“æœã€‚
    <ul>
      <li>å¯†ç å­¦å“ˆå¸Œç®—æ³•å¤šä¸è¿™ä¸ªæ–¹æ³•ç±»ä¼¼</li>
    </ul>
  </li>
  <li>å¹³æ–¹å–ä¸­æ³•(Mid-squares)ï¼Œå…ˆå¹³æ–¹ï¼Œç„¶åå–ä¸­é—´çš„ç›®æ ‡é•¿åº¦ä½</li>
  <li>é™¤æ•°ä½™ç•™æ³•ï¼ˆDivision hashingï¼‰ï¼Œç›´æ¥å–æ¨¡</li>
  <li>ä»£æ•°ç¼–ç æ³•ï¼ˆAlgebraic codingï¼‰ï¼Œç”¨æ•°å­—çš„ä¸åŒä½ä½œå˜æ¢ã€‚</li>
  <li>éšæœºæ•°æ³•ï¼Œä¸è§£é‡Šã€‚</li>
</ol>

<h3 id="ç¢°æ’å¤„ç†">ç¢°æ’å¤„ç†</h3>

<p>å¦‚æœå‘ç”Ÿäº†ç¢°æ’ï¼Œä¹Ÿå³æ˜¯è¯´ï¼Œå­˜åœ¨$a,b$ï¼Œä½¿å¾—$f(a) == f(b)$ï¼Œé‚£ä¹ˆå°±éœ€è¦è¿›è¡Œå¤„ç†ï¼Œè¿™å¤§è‡´æœ‰å››ç§åŠæ³•ï¼š</p>

<ol>
  <li>å¼€æ”¾å®šå€æ³•
    <ul>
      <li>çº¿æ€§æ¢æµ‹æ³•</li>
      <li>äºŒæ¬¡æ¢æµ‹æ³•</li>
      <li>éšæœºæ¢æµ‹æ³•</li>
    </ul>
  </li>
  <li>å†å“ˆå¸Œæ³•</li>
  <li>é“¾åœ°å€æ³•</li>
  <li>å»ºç«‹å…¬å…±æº¢å‡ºåŒºæ³•
å…·ä½“è®¨è®ºç•¥ã€‚</li>
</ol>

<h3 id="å“ˆå¸Œè¡¨çš„å®ç°--æˆ‘å®ç°çš„cç‰ˆæœ¬">å“ˆå¸Œè¡¨çš„å®ç° â€“ æˆ‘å®ç°çš„c++ç‰ˆæœ¬</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* hashtable.h */</span>

<span class="cp">#pragma once
#include &lt;bits/stdc++.h&gt;
</span>
<span class="cp">#define TYPE_KEY char *
#define TYPE_VALUE char *
#define MD5 md5
#define NOT_FIND NULL
#define NUM_NOT_FIND -1
</span>
<span class="k">typedef</span> <span class="nf">uint64_t</span> <span class="p">(</span><span class="o">*</span><span class="n">HASH_FUNC</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">class</span> <span class="nc">HashTable</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">insertTo</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">TYPE_KEY</span><span class="p">,</span> <span class="n">TYPE_VALUE</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">pair</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">deleteFrom</span><span class="p">(</span><span class="n">TYPE_KEY</span> <span class="n">key</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">uint64_t</span> <span class="n">findByKey</span><span class="p">(</span><span class="n">TYPE_KEY</span> <span class="n">key</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="n">TYPE_VALUE</span> <span class="n">getValueByKey</span><span class="p">(</span><span class="n">TYPE_KEY</span> <span class="n">key</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">LinkHashTableNode</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">T</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">LinkHashTableNode</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="n">LinkHashTableNode</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">LinkedHashTable</span> <span class="o">:</span> <span class="k">public</span> <span class="n">HashTable</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">insertTo</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">TYPE_KEY</span><span class="p">,</span> <span class="n">TYPE_VALUE</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">pair</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">deleteFrom</span><span class="p">(</span><span class="n">TYPE_KEY</span> <span class="n">key</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="n">TYPE_VALUE</span> <span class="n">getValueByKey</span><span class="p">(</span><span class="n">TYPE_KEY</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">LinkedHashTable</span><span class="p">(</span><span class="n">uint</span> <span class="n">value</span><span class="p">,</span> <span class="n">HASH_FUNC</span> <span class="n">hashFunction</span><span class="p">);</span>

<span class="nl">private:</span>
    <span class="k">virtual</span> <span class="kt">uint64_t</span> <span class="n">findByKey</span><span class="p">(</span><span class="n">TYPE_KEY</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="p">(</span><span class="n">TYPE_KEY</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">hash</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LinkHashTableNode</span><span class="o">&lt;</span><span class="n">TYPE_VALUE</span><span class="o">&gt;</span> <span class="o">*&gt;</span> <span class="n">nodePool</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* hashtable.cpp */</span>

<span class="cp">#include "./hashtable.h"
#include "md5.h"
</span>
<span class="n">LinkedHashTable</span><span class="o">::</span><span class="n">LinkedHashTable</span><span class="p">(</span><span class="n">uint</span> <span class="n">size</span><span class="p">,</span> <span class="n">HASH_FUNC</span> <span class="n">hashFunction</span><span class="p">)</span> <span class="o">:</span> <span class="n">nodePool</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="n">hashFunction</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint64_t</span> <span class="n">LinkedHashTable</span><span class="o">::</span><span class="n">findByKey</span><span class="p">(</span><span class="n">TYPE_KEY</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">hash_value</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="n">hash_value</span> <span class="o">=</span> <span class="n">hash_value</span> <span class="o">%</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nodePool</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">nodePool</span><span class="p">[</span><span class="n">hash_value</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">NUM_NOT_FIND</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">hash_value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">LinkedHashTable</span><span class="o">::</span><span class="n">insertTo</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">TYPE_KEY</span><span class="p">,</span> <span class="n">TYPE_VALUE</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">pair</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">hash_value</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
    <span class="n">hash_value</span> <span class="o">=</span> <span class="n">hash_value</span> <span class="o">%</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nodePool</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">new_node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkHashTableNode</span><span class="o">&lt;</span><span class="n">TYPE_VALUE</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
    <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nodePool</span><span class="p">[</span><span class="n">hash_value</span><span class="p">];</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">nodePool</span><span class="p">[</span><span class="n">hash_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_node</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">LinkedHashTable</span><span class="o">::</span><span class="n">deleteFrom</span><span class="p">(</span><span class="n">TYPE_KEY</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">hash_value</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">findByKey</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hash_value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">begin</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nodePool</span><span class="p">[</span><span class="n">hash_value</span><span class="p">];</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">nodePool</span><span class="p">[</span><span class="n">hash_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">begin</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
        <span class="k">delete</span> <span class="n">begin</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">TYPE_VALUE</span> <span class="n">LinkedHashTable</span><span class="o">::</span><span class="n">getValueByKey</span><span class="p">(</span><span class="n">TYPE_KEY</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">hash_value</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">findByKey</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hash_value</span> <span class="o">==</span> <span class="n">NUM_NOT_FIND</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">NOT_FIND</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nodePool</span><span class="p">[</span><span class="n">hash_value</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå¾ˆç®€å•çš„å“ˆå¸Œè¡¨ï¼Œé‡‡ç”¨é“¾åœ°å€æ³•è¿›è¡Œç¢°æ’å¤„ç†ï¼Œé‡‡ç”¨MD5ï¼ˆè¿™æ˜¯ä¸€ä¸ªå¯†ç å­¦å“ˆå¸Œå‡½æ•°ï¼‰ä½œä¸ºå“ˆå¸Œå‡½æ•°ã€‚</p>

<h3 id="rubyä¸­çš„å“ˆå¸Œè¡¨å®ç°">Rubyä¸­çš„å“ˆå¸Œè¡¨å®ç°</h3>

<p>æˆ‘ä»¬å®ç°çš„å“ˆå¸Œè¡¨ï¼Œç©å…·è‰²å½©æµ“åšï¼Œç‰¹åˆ«æ˜¯ç›´æ¥é‡‡ç”¨MD5ç®—æ³•è¿™ç§æ„šè ¢è¡Œä¸ºï¼Œæ¯æ¬¡æŸ¥è¯¢æ—¶ï¼Œéƒ½éœ€è¦åšè‡³å°‘64è½®å¾ªç¯ï¼Œæ•ˆç‡æ˜¯å¾ˆå·®çš„ã€‚</p>

<p>æ‰€ä»¥ï¼Œæœ¬ç¬”è®°çš„æœ€åä¸€éƒ¨åˆ†å°±é›†ä¸­ç²¾åŠ›æ¥è®¨è®ºä¸€ä¸ªå·¥ä¸šçº§å“ˆå¸Œè¡¨ â€“ rubyä¸­çš„å“ˆå¸Œè¡¨ã€‚</p>

<p>rubyä¸­çš„å“ˆå¸Œè¡¨ä½¿ç”¨ä¸º:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:a</span> <span class="o">=&gt;</span> <span class="s2">"haha"</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="s2">"hahaha"</span><span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ•°æ®ç»“æ„åœ¨rubyç¨‹åºä¸­ï¼Œä½¿ç”¨å¾—ç‰¹åˆ«å¹¿æ³›ã€ç‰¹åˆ«é¢‘ç¹ã€‚å¦‚æœæ²¡æœ‰ä¸€ä¸ªä¼˜ç§€çš„å†…éƒ¨å®ç°ï¼Œrubyç¨‹åºçš„æ€§èƒ½å°†ä¼šå—åˆ°å¾ˆå¤§å½±å“ã€‚</p>

<p>ç¬”è®°ç¯‡å¹…æ‰€é™ï¼Œè¿™é‡Œä¸èƒ½å®Œæ•´åœ°è®¨è®ºrubyå“ˆå¸Œè¡¨åº•å±‚å®ç°ruby/st.cä¸­1000å¤šè¡Œä»£ç çš„å…¨éƒ¨å†…å®¹ã€‚è¿™é‡Œä»…ä»…è®¨è®ºä¸€äº›æœ€é‡è¦ã€å’Œæˆ‘ä»¬æ‰€å­¦ä¹ å†…å®¹å…³ç³»æœ€å¤§çš„å†…å®¹ã€‚</p>

<p><strong>ä¸‹é¢æ‰€ç§° st_table æŒ‡çš„å°±æ˜¯rubyå†…éƒ¨çš„å“ˆå¸Œè¡¨</strong></p>

<h4 id="st_table-çš„å“ˆå¸Œå‡½æ•°">st_table çš„å“ˆå¸Œå‡½æ•°</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 537è¡Œ */</span>
    <span class="n">hash_val</span> <span class="o">=</span> <span class="n">do_hash</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>
</code></pre></div></div>

<p>ä¸Šé¢è¿™æ®µä»£ç è¡¨æ˜å“ˆå¸Œå‡½æ•°å°±æ˜¯do_hash.æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 88è¡Œ */</span>
<span class="cp">#define do_hash(key,table) (st_index_t)(*(table)-&gt;type-&gt;hash)((key))
</span></code></pre></div></div>

<p>è¿™æ®µä»£ç ä¼¼ä¹ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬æ¥ä¸€ç‚¹ç‚¹åœ°çœ‹ï¼š</p>

<p>é¦–å…ˆè¿™æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œä¼ å…¥ä¸¤ä¸ªå‚æ•°keyå’Œtableï¼Œç»™å‡ºä¸€ä¸ªå€¼ï¼Œå…¶ç±»å‹ä¸ºst_index_tï¼Œä¹Ÿå°±æ˜¯å“ˆå¸Œè¡¨çš„å…·ä½“ä½ç½®ï¼ˆæ•°ç»„ä¸‹æ ‡ï¼‰</p>

<p>ç„¶åæ¥çœ‹å…·ä½“çš„å†…å®¹</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">)((</span><span class="n">key</span><span class="p">))</span>
</code></pre></div></div>

<p>è¿™ä¸ªè¯­æ³•å…¶å®æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€‚(table)-&gt;type-&gt;hashæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘hashå‡½æ•°ï¼Œkeyæ˜¯å…¶å‚æ•°ã€‚</p>

<p>é‚£ä¹ˆæƒ³è¦æ‰¾åˆ°çœŸæ­£çš„å“ˆå¸Œå‡½æ•°ï¼Œå°±å¿…é¡»è¦æ‰¾åˆ°åˆå§‹åŒ–æ—¶è¿™ä¸ªtable-&gt;type-&gt;hashè¢«èµ‹äº†ä»€ä¹ˆå€¼ï¼š</p>

<p>å“ˆå¸Œè¡¨çš„åˆå§‹åŒ–æœ‰äº›å¤æ‚ï¼Œä½†æ˜¯ä¸ºäº†è®¨è®ºçš„æ–¹ä¾¿è¿˜æ˜¯ä»‹ç»ä¸€ä¸‹ï¼š</p>

<p>é¦–å…ˆï¼Œæ‰€æœ‰çš„åˆå§‹åŒ–éƒ½æœ€ç»ˆè¢«è½¬å‘åˆ°è¿™ä¸ªå‡½æ•°ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">st_table</span><span class="o">*</span>
<span class="n">st_init_table_with_size</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">st_hash_type</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">st_index_t</span> <span class="n">size</span><span class="p">)</span>
</code></pre></div></div>

<p>ç„¶åå®é™…ä½¿ç”¨æ—¶æœ‰ä¸‰ç§åˆå§‹åŒ–æ–¹æ³•ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">st_table</span><span class="o">*</span>
<span class="nf">st_init_numtable_with_size</span><span class="p">(</span><span class="n">st_index_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">st_init_table_with_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type_numhash</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">st_table</span><span class="o">*</span>
<span class="n">st_init_strtable_with_size</span><span class="p">(</span><span class="n">st_index_t</span> <span class="n">size</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">st_table</span><span class="o">*</span>
<span class="n">st_init_strcasetable_with_size</span><span class="p">(</span><span class="n">st_index_t</span> <span class="n">size</span><span class="p">)</span>
</code></pre></div></div>

<p>æˆ‘ä»¬è¿™é‡Œåªç ”ç©¶ç¬¬ä¸€ç§st_init_numtable_with_sizeã€‚è¿™ä¸€ç§çœ‹åå­—å°±çŸ¥é“æ˜¯æ•´æ•°å¯¹æ•´æ•°çš„æ˜ å°„ã€‚
å®ƒä¼ å…¥äº†ä¸€ä¸ªtype_numhashï¼Œè¿™çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå…¨å±€å¸¸é‡ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define type_numhash st_hashtype_num
</span><span class="k">const</span> <span class="k">struct</span> <span class="n">st_hash_type</span> <span class="n">st_hashtype_num</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">st_numcmp</span><span class="p">,</span>
    <span class="n">st_numhash</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>é‚£ä¹ˆï¼Œæ•´æ•°å¯¹æ•´æ•°çš„æ˜ å°„å®é™…ä¸Šåº”è¯¥è°ƒç”¨åˆ°st_numhashè¿™ä¸ªå‡½æ•°ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 1666 - 1683è¡Œ */</span>
<span class="n">st_index_t</span>
<span class="nf">st_numhash</span><span class="p">(</span><span class="n">st_data_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*
     * This hash function is lightly-tuned for Ruby.  Further tuning
     * should be possible.  Notes:
     *
     * - (n &gt;&gt; 3) alone is great for heap objects and OK for fixnum,
     *   however symbols perform poorly.
     * - (n &gt;&gt; (RUBY_SPECIAL_SHIFT+3)) was added to make symbols hash well,
     *   n.b.: +3 to remove ID scope, +1 worked well initially, too
     * - (n &lt;&lt; 3) was finally added to avoid losing bits for fixnums
     * - avoid expensive modulo instructions, it is currently only
     *   shifts and bitmask operations.
     */</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">st_index_t</span><span class="p">)((</span><span class="n">n</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">RUBY_SPECIAL_SHIFT</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">n</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">))</span> <span class="o">^</span> <span class="p">(</span><span class="n">n</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªå‡½æ•°çœ‹èµ·æ¥å€’æ˜¯å¾ˆç®€å•ï¼Œå°±æ˜¯ç”¨nåšäº†ä¸€äº›ä½è¿ç®—ã€‚ä¸è¿‡ä¸å±äºæ•™å¸ˆè®²è¿°çš„6ä¸­æ–¹æ³•ä¹‹ä¸€ã€‚</p>

<p>è¿™å¾ˆå¤§ç¨‹åº¦åœ°æ¿€èµ·äº†æˆ‘çš„å¥½å¥‡å¿ƒï¼šéš¾é“Indexæ˜¯32ä½çš„æ•´æ•°å—ï¼Ÿè¿™ä¸ªå‡½æ•°æ²¡æœ‰ä»»ä½•å–æ¨¡æ“ä½œï¼Œå¦‚æœä¼ å…¥ä¸€ä¸ªå¾ˆå¤§çš„n,å®ƒè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>

<p>ä¸è¦ç€æ€¥ï¼Œè®©æˆ‘ä»¬ç»§ç»­è¿½è¸ªå§ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 584 - 588è¡Œ */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="n">key</span><span class="p">);</span>
<span class="n">add_direct</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">hash_val</span><span class="p">,</span> <span class="n">bin_pos</span><span class="p">);</span>
<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬æ³¨æ„åˆ°bin_posè¿™ä¸ªå‚æ•°ï¼Œå› ä¸ºåœ¨add_directå‡½æ•°ä¸­ï¼Œå®ƒä¼šè°ƒç”¨new_entryå‡½æ•°ï¼Œæœ€åä¼šæ‰§è¡Œè¿™ä¸ªè¯­å¥ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 445 è¡Œ */</span> 
<span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">bins</span><span class="p">[</span><span class="n">bin_pos</span><span class="p">];</span>
<span class="n">table</span><span class="o">-&gt;</span><span class="n">bins</span><span class="p">[</span><span class="n">bin_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
</code></pre></div></div>

<p>æ˜¾ç„¶åœ°ï¼Œbin_posæ‰æ˜¯æ•°ç»„æŸ¥æ‰¾çš„çœŸæ­£ä¸‹æ ‡ï¼é‚£ä¹ˆbin_posæ˜¯åœ¨å“ªé‡Œè¢«è®¾ç½®çš„å‘¢ï¼Ÿä¸€ä¸ªå‡ºä¹é¢„æ–™çš„ç­”æ¡ˆæ˜¯åœ¨FIND_ENTRYå®ä¸­ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 582è¡Œ*/</span>
    <span class="n">FIND_ENTRY</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">hash_val</span><span class="p">,</span> <span class="n">bin_pos</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 344è¡Œ */</span>
<span class="cp">#define FIND_ENTRY(table, ptr, hash_val, bin_pos) \
    ((ptr) = find_entry((table), key, (hash_val), ((bin_pos) = hash_pos(hash_val, (table)-&gt;num_bins))))
</span></code></pre></div></div>

<p>ç»å†äº†åƒè¾›ä¸‡è‹¦ï¼Œæˆ‘ä»¬ç»ˆäºæ¥åˆ°äº†çœŸæ­£è·å–ä¸‹æ ‡çš„hash_poså®ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 89è¡Œ */</span>
<span class="cp">#define hash_pos(h,n) ((h) &amp; (n - 1))
</span></code></pre></div></div>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå®é™…çš„ä¸‹æ ‡æ˜¯å’Œå“ˆå¸Œè¡¨çš„é•¿åº¦ä¸ä¹‹åçš„ç»“æœã€‚</p>

<p>æœ‰äººå¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¦æœ‰ä¸¤å¥—é”®ï¼ˆä¸€ä¸ªhash_valï¼Œä¸€ä¸ªbin_posï¼‰å‘¢ï¼Ÿæˆ‘ä»¬ä¸‹é¢ä¼šè°ˆåˆ°ï¼Œè¿™é‡ŒåŸ‹ä¸ªä¼ç¬”ã€‚ä¸è¿‡åœ¨è°ˆåˆ°è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¦çœ‹çœ‹å®ƒçš„ç¢°æ’å¤„ç†ã€‚</p>

<h4 id="st_tableçš„ç¢°æ’å¤„ç†">st_tableçš„ç¢°æ’å¤„ç†</h4>

<p>å¦‚æœFIND_ENTRYå®æ‰¾åˆ°äº†è¯¥keyï¼Œst_tableä¼šå¦‚ä½•å¤„ç†å‘¢ï¼Ÿå…¶å®ï¼Œè¿™ä¸ªé—®é¢˜åœ¨add_directè°ƒç”¨çš„new_enrtyå‡½æ•°é‚£é‡Œå°±å¯ä»¥çœ‹å‡ºæ¥ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 445 - 446è¡Œ */</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">bins</span><span class="p">[</span><span class="n">bin_pos</span><span class="p">];</span>
    <span class="n">table</span><span class="o">-&gt;</span><span class="n">bins</span><span class="p">[</span><span class="n">bin_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
</code></pre></div></div>

<p>è¿™å†™æ³•æ˜¾ç„¶æ˜¯é“¾è¡¨çš„å¤´æ’æ³•ï¼Œæ‰€ä»¥æ˜¯é“¾åœ°å€æ³•ã€‚</p>

<h4 id="st_tableçš„æ‰©å®¹">st_tableçš„æ‰©å®¹</h4>

<p>åœ¨æˆ‘ä»¬å®ç°çš„å“ˆå¸Œè¡¨ä¸­ï¼ŒçœŸæ­£çš„å“ˆå¸Œç®—æ³•ä¸ºï¼š
\(hash = MD5(key) \% n\)
è¿™æ ·ä¸€æ¥å¸¦æ¥ä¸€ä¸ªå¾ˆéº»çƒ¦çš„é—®é¢˜ â€“ æ‰©å®¹æ—¶å¿…é¡»é‡æ–°è®¡ç®—å“ˆå¸Œå€¼ã€‚</p>

<p>è€Œæˆ‘ä»¬å¯ä»¥çŒœæƒ³åˆ°ï¼Œå¾—ç›Šäºrubyå“ˆå¸Œè¡¨ä¸­hash_valå’Œbin_posçš„åˆ†ç¦»ï¼Œæ‰©å®¹æ—¶åªéœ€è¦é‡æ–°è®¡ç®—bin_posï¼Œè€Œä¸éœ€è¦é‡æ–°è®¡ç®—å“ˆå¸Œå€¼ã€‚</p>

<p>çœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿè®©æˆ‘ä»¬å†çœ‹çœ‹æºä»£ç ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 459 - 462è¡Œ */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">&gt;</span> <span class="n">ST_DEFAULT_MAX_DENSITY</span> <span class="o">*</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">num_bins</span><span class="p">)</span> <span class="p">{</span>
<span class="n">rehash</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
    <span class="n">bin_pos</span> <span class="o">=</span> <span class="n">hash_pos</span><span class="p">(</span><span class="n">hash_val</span><span class="p">,</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">num_bins</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œå¦‚æœç°åœ¨çš„å“ˆå¸Œè¡¨é¡¹æ•°å¤§äºå¯ä»¥å®¹çº³çš„æœ€å¤§æ•°é‡ * ä¸€ä¸ªå¯†åº¦å¸¸æ•°ï¼Œé‚£ä¹ˆå°±ç”¨rehash()å‡½æ•°é‡æ–°å¯¹è¿™ä¸ªè¡¨ä½œå“ˆå¸Œï¼Œè€Œrehash()å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 609 - 627è¡Œ */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rehash</span><span class="p">(</span><span class="k">register</span> <span class="n">st_table</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">st_table_entry</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">**</span><span class="n">new_bins</span><span class="p">;</span>
    <span class="n">st_index_t</span> <span class="n">new_num_bins</span><span class="p">,</span> <span class="n">hash_val</span><span class="p">;</span>

    <span class="n">new_num_bins</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">num_bins</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">new_bins</span> <span class="o">=</span> <span class="n">st_realloc_bins</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">bins</span><span class="p">,</span> <span class="n">new_num_bins</span><span class="p">,</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">num_bins</span><span class="p">);</span>
    <span class="n">table</span><span class="o">-&gt;</span><span class="n">num_bins</span> <span class="o">=</span> <span class="n">new_num_bins</span><span class="p">;</span>
    <span class="n">table</span><span class="o">-&gt;</span><span class="n">bins</span> <span class="o">=</span> <span class="n">new_bins</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">do</span> <span class="p">{</span>
	    <span class="n">hash_val</span> <span class="o">=</span> <span class="n">hash_pos</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="n">new_num_bins</span><span class="p">);</span>
	    <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">new_bins</span><span class="p">[</span><span class="n">hash_val</span><span class="p">];</span>
	    <span class="n">new_bins</span><span class="p">[</span><span class="n">hash_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">fore</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç æœ‰ä¸¤ä¸ªåœ°æ–¹éœ€è¦ç ”ç©¶</p>

<ol>
  <li>new_sizeæ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ–°çš„å¤§å°å’Œç°å¤§å°æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</li>
  <li>ç°åœ¨çš„å“ˆå¸Œè¡¨æ˜¯å¦‚ä½•è¿ç§»åˆ°æ–°çš„å“ˆå¸Œè¡¨çš„ï¼Ÿ</li>
</ol>

<p>é¦–å…ˆç ”ç©¶ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç›´æ¥ç ”ç©¶new_sizeå‡½æ•°ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 157 - 172è¡Œ */</span>
<span class="k">static</span> <span class="n">st_index_t</span>
<span class="nf">new_size</span><span class="p">(</span><span class="n">st_index_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">st_index_t</span> <span class="n">n</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="cm">/* already a power-of-two? */</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">next_pow2</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="cp">#ifndef NOT_RUBY
</span>    <span class="n">rb_raise</span><span class="p">(</span><span class="n">rb_eRuntimeError</span><span class="p">,</span> <span class="s">"st_table too big"</span><span class="p">);</span>
<span class="cp">#endif
</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>			<span class="cm">/* should raise exception */</span>
<span class="p">}</span>
</code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸‹ä¸€ä¸ªå¤§å°æ˜¯next_pow2ç®—å‡ºæ¥çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ–°çš„å¤§å°å’Œæ—§çš„å¤§å°æœ‰å¦‚ä¸‹å…³ç³»ï¼š
\(size_{new} = 2 \times size_{former}\)</p>

<p>ç„¶åç ”ç©¶ç¬¬äºŒä¸ªé—®é¢˜ï¼Œç°åœ¨çš„å“ˆå¸Œè¡¨å¦‚ä½•è¿ç§»åˆ°æ–°çš„å“ˆå¸Œè¡¨ã€‚</p>

<p>é¦–å…ˆï¼Œst_realloc_binsåªä¼šé‡æ–°åˆ†é…å†…å­˜ï¼Œè€Œä¸ä¼šè¿ç§»ï¼ŒçœŸæ­£çš„è¿ç§»åœ¨è¿™ä¸ªå¾ªç¯ä¸­è¿›è¡Œï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">do</span> <span class="p">{</span>
	    <span class="n">hash_val</span> <span class="o">=</span> <span class="n">hash_pos</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="n">new_num_bins</span><span class="p">);</span>
	    <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">new_bins</span><span class="p">[</span><span class="n">hash_val</span><span class="p">];</span>
	    <span class="n">new_bins</span><span class="p">[</span><span class="n">hash_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">fore</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¦è¯´æ˜ç™½è¿™ä¸ªå¾ªç¯ï¼Œå¿…é¡»è®¤çœŸç ”ç©¶ä¸€ä¸‹st_table_entryï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ruby/st.c 18 - 26è¡Œ */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">st_table_entry</span> <span class="n">st_table_entry</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">st_table_entry</span> <span class="p">{</span>
    <span class="n">st_index_t</span> <span class="n">hash</span><span class="p">;</span>
    <span class="n">st_data_t</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">st_data_t</span> <span class="n">record</span><span class="p">;</span>
    <span class="n">st_table_entry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="n">st_table_entry</span> <span class="o">*</span><span class="n">fore</span><span class="p">,</span> <span class="o">*</span><span class="n">back</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>è¿™ä¸ªnextï¼ŒæŒ‡å‘çš„æ˜¯æœ¬bin_posçš„ä¸‹ä¸€ä¸ªé¡¹ï¼›è€Œforeå’Œbackï¼Œå®é™…ä¸Šæ˜¯æŠŠæ•´ä¸ªå“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„é¡¹åšæˆäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼</p>

<p>å›è¿‡å¤´æ¥å†çœ‹add_directçš„æœ€åä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¼šæœ‰ç§æç„¶å¤§æ‚Ÿçš„æ„Ÿè§‰ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="n">entry</span><span class="o">-&gt;</span><span class="n">fore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">back</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fore</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="n">table</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
<span class="n">table</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="n">entry</span><span class="o">-&gt;</span><span class="n">fore</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">back</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¹Ÿæ­£æ˜¯åŒå‘é“¾è¡¨çš„æ’å…¥æ“ä½œï¼Œå…¶ä¸­table-&gt;headæ˜¯å¤´æŒ‡é’ˆï¼Œtable-&gt;tailæ˜¯å°¾æŒ‡é’ˆã€‚è¿™æ ·ä¸€æ¥ï¼Œæ‰€æœ‰çš„é¡¹éƒ½ä¸²æˆäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œé€šè¿‡ä»å¤´æŒ‡é’ˆå¼€å§‹çš„éå†å°±å¯ä»¥å°†æ‰€æœ‰çš„é¡¹åŠ å…¥æ–°çš„å“ˆå¸Œè¡¨ä¸­ï¼Œè€Œè¿™æ­£æ˜¯è¿™ä¸ªå¾ªç¯æ‰€åšçš„äº‹æƒ…ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">do</span> <span class="p">{</span>
	<span class="n">hash_val</span> <span class="o">=</span> <span class="n">hash_pos</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="n">new_num_bins</span><span class="p">);</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">new_bins</span><span class="p">[</span><span class="n">hash_val</span><span class="p">];</span>
	<span class="n">new_bins</span><span class="p">[</span><span class="n">hash_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">fore</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<p>ç‰¹åˆ«åœ°ï¼Œæˆ‘ä»¬å‘ç°å®ƒç¡®å®åªæ˜¯å°†å“ˆå¸Œå€¼ç”¨hash_poså®å˜ä¸ºäº†bin_posï¼Œå³ä¸‹æ ‡ï¼Œä»è€Œé¿å…äº†å†æ¬¡å“ˆå¸Œé”®ã€‚</p>

<h4 id="æ€»ç»“">æ€»ç»“</h4>

<p>æ€»çš„æ¥è¯´ï¼Œrubyä¸­çš„å“ˆå¸Œè¡¨æœ‰è¿™å‡ ä¸ªç‰¹æ€§ï¼š</p>

<ol>
  <li>å“ˆå¸Œå‡½æ•°æ˜¯å°†é”®åšä¸å¾ªç¯çš„ä½è¿ç®—ã€‚</li>
  <li>å“ˆå¸Œå€¼å’ŒçœŸæ­£çš„ä¸‹æ ‡åˆ†ç¦»ï¼ŒçœŸæ­£çš„ä¸‹æ ‡ç”±å“ˆå¸Œå€¼é€»è¾‘ä¸å“ˆå¸Œè¡¨é•¿åº¦å¾—åˆ°ï¼Œæ‰©å®¹æ—¶ä¸éœ€è¦å†æ¬¡è®¡ç®—å“ˆå¸Œå€¼ï¼Œåªéœ€è¦å†æ¬¡è®¡ç®—çœŸæ­£çš„ä¸‹æ ‡ã€‚</li>
  <li>å†²çªå¤„ç†é‡‡ç”¨é“¾åœ°å€æ³•ã€‚</li>
  <li>å®¹é‡æ°¸è¿œæ˜¯2çš„næ¬¡æ–¹ï¼Œæ‰©å®¹æ—¶ï¼Œæ–°çš„å®¹é‡æ˜¯ç°å®¹é‡çš„ä¸¤å€</li>
  <li>å°†æ‰€æœ‰çš„å“ˆå¸Œè¡¨é¡¹ç”¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸²èµ·æ¥ï¼Œç”¨å¤´æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆå®ç°å¯¹æ•´ä¸ªå“ˆå¸Œè¡¨çš„é«˜æ•ˆéå†ã€‚</li>
</ol>

:ET