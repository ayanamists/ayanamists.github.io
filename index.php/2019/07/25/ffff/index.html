<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>编写程序验证《全部成为F》中的巧妙trick | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="我们在写程序时，时常要用到文件操作。文件操作是一种I&#x2F;O读写，必定要用到系统调用或API。在WinApi的CreateFile函数中 HANDLE CreateFileA(   LPCSTR                lpFileName,   DWORD                 dwDesiredAccess,   DWORD                 dwShareMode,">
<meta property="og:type" content="article">
<meta property="og:title" content="编写程序验证《全部成为F》中的巧妙trick">
<meta property="og:url" content="http://example.com/index.php/2019/07/25/ffff/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="我们在写程序时，时常要用到文件操作。文件操作是一种I&#x2F;O读写，必定要用到系统调用或API。在WinApi的CreateFile函数中 HANDLE CreateFileA(   LPCSTR                lpFileName,   DWORD                 dwDesiredAccess,   DWORD                 dwShareMode,">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-1024x161.png">
<meta property="og:image" content="https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-2.png">
<meta property="og:image" content="https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-1.png">
<meta property="article:published_time" content="2019-07-25T03:48:18.000Z">
<meta property="article:modified_time" content="2020-10-11T04:43:47.184Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-1024x161.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2019-07-25-ffff" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/index.php/2019/07/25/ffff/" class="article-date">
  <time datetime="2019-07-25T03:48:18.000Z" itemprop="datePublished">2019-07-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/C-C/">C/C++</a>►<a class="article-category-link" href="/categories/C-C/%E5%8A%A8%E7%94%BB/">动画</a>►<a class="article-category-link" href="/categories/C-C/%E5%8A%A8%E7%94%BB/%E6%9C%AA%E5%88%86%E7%B1%BB/">未分类</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      编写程序验证《全部成为F》中的巧妙trick
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我们在写程序时，时常要用到文件操作。文件操作是一种I/O读写，必定要用到系统调用或API。在WinApi的CreateFile函数中</p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">HANDLE CreateFileA(
  LPCSTR                lpFileName,
  DWORD                 dwDesiredAccess,
  DWORD                 dwShareMode,
  LPSECURITY_ATTRIBUTES lpSecurityAttributes,
  DWORD                 dwCreationDisposition,
  DWORD                 dwFlagsAndAttributes,
  HANDLE                hTemplateFile
);

</pre>

<p>倒数第二个参数设置为 CREATE_ALWAYS时，创建的新文件会覆盖原有的同名文件。《终将成为F》就利用了类似的思想，构造了一个非常巧妙的结构。</p>
<p>假设一个监控程序P，它在每分钟开始的时刻创建监控文件，这个文件记录该分钟内的事件。考虑以下情况：在程序开始运行时，系统时间比标准时间快1分钟（这里的“快”指数值比标准时间大）。在程序运行的过程中，系统通过校准，将时间调整为了标准时间，会发生什么呢？</p>
<p>假设调整为标准时间的时刻是a:b:c（标准时间），那么该系统错误显示的时间就是a:(b+1):c。假设P在a:(b+1):00（系统时间）时刻创建的文件名为a:b+1，那么在系统正确显示后，在新的a:b+1时刻，系统会创建新的a:b+1文件。这样一来，实际上的a:b（标准时间）文件就被覆盖了。《全部成为F》的作者就用这样的构造，做出了一个密室。具体情况可参见小说或动画。</p>
<p>我在WINDOWS环境下编写了以下程序来验证这个构造的正确性：</p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">SYSTEMTIME time;
GetLocalTime(&time);</pre>

<pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">while (true)
{
    while (true)
    {
        GetLocalTime(&time);
        if (time.wSecond == 0 && time.wMilliseconds == 0)
        {
            break;
        }
    }

    wchar_t* name = (wchar_t*)malloc(0xff);
    memset(name, 0, 0xff);
    wsprintf(name, L"Time is %02d：%02d", time.wHour, time.wMinute);

    HANDLE hFile = CreateFile(name, GENERIC_READ | GENERIC_WRITE, 
        0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);

    if (hFile == INVALID_HANDLE_VALUE)
    {
        GetError(0);
        exit(-1);
    }

    DWORD real = 0;     

    if (WriteFile(hFile, &count, 4, &real, NULL) == false)
    {
        GetError(1);
        exit(-1);
    }

    Sleep(1);
    count++;
    CloseHandle(hFile);
    free(name);
}</pre>

<p>在运行前，我将系统时间调快了一分钟，并在运行时开启自动对时。结果成功地验证了该构造的正确性。<figure class="wp-block-image"></p>
<p><img src="https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-1024x161.png" alt="" class="wp-image-119" srcset="https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-1024x161.png 1024w, https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-300x47.png 300w, https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-768x121.png 768w" sizes="(max-width: 1024px) 100vw, 1024px" /> </figure> <figure class="wp-block-image is-resized"><img src="https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-2.png" alt="" class="wp-image-122" width="354" height="153" srcset="https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-2.png 749w, https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-2-300x129.png 300w" sizes="(max-width: 354px) 100vw, 354px" /></figure> </p>
<p>2:55的计数为0，2：56的计数为1……系统在2：58调整为了正确的时间，按照前述，2：58的计数应该为4，因为计数为3的2：58文件被覆盖了。用WINHEX查看：<figure class="wp-block-image is-resized"></p>
<p><img src="https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-1.png" alt="" class="wp-image-120" width="591" height="212" srcset="https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-1.png 909w, https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-1-300x108.png 300w, https://blog.ayanamists.xyz/wp-content/uploads/2019/07/image-1-768x275.png 768w" sizes="(max-width: 591px) 100vw, 591px" /> <figcaption>4在前面是因为x86采取小端序，小端在前</figcaption></figure> </p>
<p>这样来就验证了该结构的正确性。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/index.php/2019/07/25/ffff/" data-id="ckg4mhp1h000317sb6m7u8146" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/index.php/2019/08/06/iredmail/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          使用iRedMail配置邮箱服务器
        
      </div>
    </a>
  
  
    <a href="/index.php/2019/07/17/maxituan/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">魔偶马戏团：不幸的动画与伟大的原作</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/802-11i/">802.11i</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/%E5%8A%A8%E7%94%BB/">动画</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/%E5%8A%A8%E7%94%BB/%E6%9C%AA%E5%88%86%E7%B1%BB/">未分类</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/network-speed/">network_speed</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A8%E7%94%BB/">动画</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A8%E7%94%BB/%E6%BC%AB%E7%94%BB/">漫画</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/">未分类</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/10/11/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2020/10/11/2019-12-22-Graph/">数据结构 -- 图 -- 笔记</a>
          </li>
        
          <li>
            <a href="/2020/10/11/2020-1-2-sort/">数据结构 -- 排序 -- 笔记</a>
          </li>
        
          <li>
            <a href="/2020/10/03/2020-10-03-mma/">mathematica入坑指南</a>
          </li>
        
          <li>
            <a href="/2020/09/15/2020-09-25-fuck-the-signal/">f(x)记法的滥用与匿名函数</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>